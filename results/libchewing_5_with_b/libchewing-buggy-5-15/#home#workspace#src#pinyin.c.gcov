        -:    0:Source:/home/workspace/src/pinyin.c
        -:    1:/**
        -:    2: * pinyin.c
        -:    3: *
        -:    4: * Copyright (c) 2005, 2006, 2008, 2012-2014
        -:    5: *	libchewing Core Team. See ChangeLog for details.
        -:    6: *
        -:    7: * See the file "COPYING" for information on usage and redistribution
        -:    8: * of this file.
        -:    9: */
        -:   10:
        -:   11:/* @(#)pinyin.c
        -:   12: */
        -:   13:
        -:   14:#include <stdio.h>
        -:   15:#include <string.h>
        -:   16:#include <stdlib.h>
        -:   17:
        -:   18:#include "global-private.h"
        -:   19:#include "pinyin-private.h"
        -:   20:#include "bopomofo-private.h"
        -:   21:#include "private.h"
        -:   22:
        3:   23:void TerminatePinyin(ChewingData *pgdata)
        -:   24:{
        3:   25:    free(pgdata->static_data.hanyuInitialsMap);
        3:   26:    free(pgdata->static_data.hanyuFinalsMap);
        3:   27:}
        -:   28:
        3:   29:int InitPinyin(ChewingData *pgdata, const char *prefix)
        -:   30:{
        -:   31:    char filename[PATH_MAX];
        -:   32:    int i;
        -:   33:    FILE *fd;
        -:   34:    int ret;
        -:   35:
        3:   36:    sprintf(filename, "%s" PLAT_SEPARATOR "%s", prefix, PINYIN_TAB_NAME);
        -:   37:
        3:   38:    fd = fopen(filename, "r");
        -:   39:
        3:   40:    if (!fd)
    #####:   41:        return 0;
        -:   42:
        3:   43:    ret = fscanf(fd, "%d", &pgdata->static_data.HANYU_INITIALS);
        3:   44:    if (ret != 1) {
    #####:   45:        return 0;
        -:   46:    }
        3:   47:    ++pgdata->static_data.HANYU_INITIALS;
        3:   48:    pgdata->static_data.hanyuInitialsMap = ALC(keymap, pgdata->static_data.HANYU_INITIALS);
       78:   49:    for (i = 0; i < pgdata->static_data.HANYU_INITIALS - 1; i++) {
       75:   50:        ret = fscanf(fd, "%s %s",
       75:   51:                     pgdata->static_data.hanyuInitialsMap[i].pinyin, pgdata->static_data.hanyuInitialsMap[i].bopomofo);
       75:   52:        if (ret != 2) {
    #####:   53:            return 0;
        -:   54:        }
        -:   55:    }
        -:   56:
        3:   57:    ret = fscanf(fd, "%d", &pgdata->static_data.HANYU_FINALS);
        3:   58:    if (ret != 1) {
    #####:   59:        return 0;
        -:   60:    }
        3:   61:    ++pgdata->static_data.HANYU_FINALS;
        3:   62:    pgdata->static_data.hanyuFinalsMap = ALC(keymap, pgdata->static_data.HANYU_FINALS);
      273:   63:    for (i = 0; i < pgdata->static_data.HANYU_FINALS - 1; i++) {
      270:   64:        ret = fscanf(fd, "%s %s",
      270:   65:                     pgdata->static_data.hanyuFinalsMap[i].pinyin, pgdata->static_data.hanyuFinalsMap[i].bopomofo);
      270:   66:        if (ret != 2) {
    #####:   67:            return 0;
        -:   68:        }
        -:   69:    }
        -:   70:
        3:   71:    fclose(fd);
        -:   72:
        3:   73:    return 1;
        -:   74:}
        -:   75:
        -:   76:/**
        -:   77: * Map pinyin key-sequence to Bopomofo key-sequence.
        -:   78: * Caller should allocate char bopomofo[4].
        -:   79: *
        -:   80: * Non-Zero: Fail to fully convert
        -:   81: *
        -:   82: * @retval 0 Success
        -:   83: */
    #####:   84:int PinyinToBopomofo(ChewingData *pgdata, const char *pinyinKeySeq, char *bopomofoKeySeq, char *bopomofoKeySeqAlt)
        -:   85:{
    #####:   86:    const char *p, *cursor = NULL;
    #####:   87:    const char *initial = 0;
    #####:   88:    const char *final = 0;
    #####:   89:    const char *seq = 0;
        -:   90:    int i;
        -:   91:
        -:   92:    /* special cases for WG */
    #####:   93:    if (!strcmp(pinyinKeySeq, "tzu")) {
    #####:   94:        seq = "y yj";           /* ㄗ|ㄗㄨ */
    #####:   95:    } else if (!strcmp(pinyinKeySeq, "ssu") || !strcmp(pinyinKeySeq, "szu")) {
    #####:   96:        seq = "n n";            /* ㄙ|ㄙㄨ */
        -:   97:    }
        -:   98:
        -:   99:    /* common multiple mapping */
    #####:  100:    if (!strcmp(pinyinKeySeq, "e")) {
    #####:  101:        seq = "k ,";            /* ㄜ|ㄝ */
    #####:  102:    } else if (!strcmp(pinyinKeySeq, "ch")) {
    #####:  103:        seq = "t f";            /* ㄔ|ㄑ */
    #####:  104:    } else if (!strcmp(pinyinKeySeq, "sh")) {
    #####:  105:        seq = "g v";            /* ㄕ|ㄒ */
    #####:  106:    } else if (!strcmp(pinyinKeySeq, "c")) {
    #####:  107:        seq = "h f";            /* ㄘ|ㄑ */
    #####:  108:    } else if (!strcmp(pinyinKeySeq, "s")) {
    #####:  109:        seq = "n v";            /* ㄙ|ㄒ */
    #####:  110:    } else if (!strcmp(pinyinKeySeq, "nu")) {
    #####:  111:        seq = "sj sm";          /* ㄋㄨ|ㄋㄩ */
    #####:  112:    } else if (!strcmp(pinyinKeySeq, "lu")) {
    #####:  113:        seq = "xj xm";          /* ㄌㄨ|ㄌㄩ */
    #####:  114:    } else if (!strcmp(pinyinKeySeq, "luan")) {
    #####:  115:        seq = "xj0 xm0";        /* ㄌㄨㄢ|ㄌㄩㄢ */
    #####:  116:    } else if (!strcmp(pinyinKeySeq, "niu")) {
    #####:  117:        seq = "su. sm";         /* ㄋㄧㄡ|ㄋㄩ */
    #####:  118:    } else if (!strcmp(pinyinKeySeq, "liu")) {
    #####:  119:        seq = "xu. xm";         /* ㄌㄧㄡ|ㄌㄩ */
    #####:  120:    } else if (!strcmp(pinyinKeySeq, "jiu")) {
    #####:  121:        seq = "ru. rm";         /* ㄐㄧㄡ|ㄐㄩ */
    #####:  122:    } else if (!strcmp(pinyinKeySeq, "chiu")) {
    #####:  123:        seq = "fu. fm";         /* ㄑㄧㄡ|ㄑㄩ */
    #####:  124:    } else if (!strcmp(pinyinKeySeq, "shiu")) {
    #####:  125:        seq = "vu. vm";         /* ㄒㄧㄡ|ㄒㄩ */
    #####:  126:    } else if (!strcmp(pinyinKeySeq, "ju")) {
    #####:  127:        seq = "rm 5j";          /* ㄐㄩ|ㄓㄨ */
    #####:  128:    } else if (!strcmp(pinyinKeySeq, "juan")) {
    #####:  129:        seq = "rm0 5j0";        /* ㄐㄩㄢ|ㄓㄨㄢ */
        -:  130:    }
        -:  131:
        -:  132:    /* multiple mapping for each kbtype */
    #####:  133:    switch (pgdata->bopomofoData.kbtype) {
    #####:  134:    case KB_HANYU_PINYIN:
    #####:  135:        if (!strcmp(pinyinKeySeq, "chi")) {
    #####:  136:            seq = "t fu";       /* ㄔ|ㄑㄧ */
    #####:  137:        } else if (!strcmp(pinyinKeySeq, "shi")) {
    #####:  138:            seq = "g vu";       /* ㄕ|ㄒㄧ */
    #####:  139:        } else if (!strcmp(pinyinKeySeq, "ci")) {
    #####:  140:            seq = "h fu";       /* ㄘ|ㄑㄧ */
    #####:  141:        } else if (!strcmp(pinyinKeySeq, "si")) {
    #####:  142:            seq = "n vu";       /* ㄙ|ㄒㄧ */
        -:  143:        }
    #####:  144:        break;
    #####:  145:    case KB_THL_PINYIN:
    #####:  146:        if (!strcmp(pinyinKeySeq, "chi")) {
    #####:  147:            seq = "fu t";       /* ㄑㄧ|ㄔ */
    #####:  148:        } else if (!strcmp(pinyinKeySeq, "shi")) {
    #####:  149:            seq = "vu g";       /* ㄒㄧ|ㄕ */
    #####:  150:        } else if (!strcmp(pinyinKeySeq, "ci")) {
    #####:  151:            seq = "fu h";       /* ㄑㄧ|ㄘ */
    #####:  152:        } else if (!strcmp(pinyinKeySeq, "si")) {
    #####:  153:            seq = "vu n";       /* ㄒㄧ|ㄙ */
        -:  154:        }
    #####:  155:        break;
    #####:  156:    case KB_MPS2_PINYIN:
    #####:  157:        if (!strcmp(pinyinKeySeq, "chi")) {
    #####:  158:            seq = "fu t";       /* ㄑㄧ|ㄔ */
    #####:  159:        } else if (!strcmp(pinyinKeySeq, "shi")) {
    #####:  160:            seq = "vu g";       /* ㄒㄧ|ㄕ */
    #####:  161:        } else if (!strcmp(pinyinKeySeq, "ci")) {
    #####:  162:            seq = "fu h";       /* ㄑㄧ|ㄘ */
    #####:  163:        } else if (!strcmp(pinyinKeySeq, "si")) {
    #####:  164:            seq = "vu n";       /* ㄒㄧ|ㄙ */
    #####:  165:        } else if (!strcmp(pinyinKeySeq, "niu")) {
    #####:  166:            seq = "sm su.";     /* ㄋㄩ|ㄋㄧㄡ */
    #####:  167:        } else if (!strcmp(pinyinKeySeq, "liu")) {
    #####:  168:            seq = "xm xu.";     /* ㄌㄩ|ㄌㄧㄡ */
    #####:  169:        } else if (!strcmp(pinyinKeySeq, "jiu")) {
    #####:  170:            seq = "rm ru.";     /* ㄐㄩ|ㄐㄧㄡ */
    #####:  171:        } else if (!strcmp(pinyinKeySeq, "chiu")) {
    #####:  172:            seq = "fm fu.";     /* ㄑㄩ|ㄑㄧㄡ */
    #####:  173:        } else if (!strcmp(pinyinKeySeq, "shiu")) {
    #####:  174:            seq = "vm vu.";     /* ㄒㄩ|ㄒㄧㄡ */
    #####:  175:        } else if (!strcmp(pinyinKeySeq, "ju")) {
    #####:  176:            seq = "5j rm";      /* ㄓㄨ|ㄐㄩ */
    #####:  177:        } else if (!strcmp(pinyinKeySeq, "juan")) {
    #####:  178:            seq = "5j0 rm0";    /* ㄓㄨㄢ|ㄐㄩㄢ */
    #####:  179:        } else if (!strcmp(pinyinKeySeq, "juen")) {
    #####:  180:            seq = "5jp 5jp";    /* ㄓㄨㄣ|ㄓㄨㄣ */
    #####:  181:        } else if (!strcmp(pinyinKeySeq, "tzu")) {
    #####:  182:            seq = "yj y";       /* ㄗㄨ|ㄗ */
        -:  183:        }
    #####:  184:        break;
        -:  185:    }
    #####:  186:    if (seq != NULL) {
        -:  187:        char s[BOPOMOFO_SIZE * 2 + 1];
        -:  188:
    #####:  189:        strcpy(s, seq);
    #####:  190:        initial = strtok(s, " ");
    #####:  191:        strcpy(bopomofoKeySeq, initial);
    #####:  192:        initial = strtok(NULL, " ");
    #####:  193:        strcpy(bopomofoKeySeqAlt, initial);
    #####:  194:        return 0;
        -:  195:    }
        -:  196:
        -:  197:
    #####:  198:    for (i = 0; i < pgdata->static_data.HANYU_INITIALS; i++) {
    #####:  199:        p = strstr(pinyinKeySeq, pgdata->static_data.hanyuInitialsMap[i].pinyin);
    #####:  200:        if (p == pinyinKeySeq) {
    #####:  201:            initial = pgdata->static_data.hanyuInitialsMap[i].bopomofo;
    #####:  202:            cursor = pinyinKeySeq + strlen(pgdata->static_data.hanyuInitialsMap[i].pinyin);
    #####:  203:            break;
        -:  204:        }
        -:  205:    }
    #####:  206:    if (i == pgdata->static_data.HANYU_INITIALS) {
        -:  207:        /* No initials. might be ㄧㄨㄩ */
        -:  208:        /* XXX: I NEED Implementation
        -:  209:           if(finalsKeySeq[0] != ) {
        -:  210:           }
        -:  211:         */
    #####:  212:        return 1;
        -:  213:    }
        -:  214:
    #####:  215:    if (cursor) {
    #####:  216:        for (i = 0; i < pgdata->static_data.HANYU_FINALS; i++) {
    #####:  217:            if (strcmp(cursor, pgdata->static_data.hanyuFinalsMap[i].pinyin) == 0) {
    #####:  218:                final = pgdata->static_data.hanyuFinalsMap[i].bopomofo;
    #####:  219:                break;
        -:  220:            }
        -:  221:        }
    #####:  222:        if (i == pgdata->static_data.HANYU_FINALS) {
    #####:  223:            return 2;
        -:  224:        }
        -:  225:    }
        -:  226:
        -:  227:
        -:  228:    /* THL empty rime
        -:  229:     * we use '=' in pinyin.tab as empty rime, restore it to ''
        -:  230:     */
    #####:  231:    if (!strcmp(final, "=")) {
    #####:  232:        final = "";
        -:  233:    }
        -:  234:
        -:  235:    /* Hanyu empty rime
        -:  236:     * ㄓ/ㄔ/ㄕ/ㄖ/ㄗ/ㄘ/ㄙ + -i, -i is empty rime, not ㄧ
        -:  237:     * */
    #####:  238:    if (!strcmp(final, "u")) {
    #####:  239:        if (!strcmp(initial, "5") ||
    #####:  240:            !strcmp(initial, "t") ||
    #####:  241:            !strcmp(initial, "g") ||
    #####:  242:            !strcmp(initial, "b") || !strcmp(initial, "y") || !strcmp(initial, "h") || !strcmp(initial, "n")) {
    #####:  243:            final = "";
        -:  244:        }
        -:  245:    }
        -:  246:
        -:  247:    /* Hanyu uan/un/u :
        -:  248:     * ㄐ/ㄑ/ㄒ + -uan, -uan is ㄩㄢ, not ㄨㄢ
        -:  249:     * ㄐ/ㄑ/ㄒ + -un,  -un is ㄩㄣ, not ㄨㄣ
        -:  250:     * ㄐ/ㄑ/ㄒ + -u,   -u is ㄧ, not ㄨ
        -:  251:     */
    #####:  252:    if (!strcmp(initial, "f") || !strcmp(initial, "r") || !strcmp(initial, "v")) {
    #####:  253:        if (!strcmp(final, "j0")) {
    #####:  254:            final = "m0";
    #####:  255:        } else if (!strcmp(final, "jp")) {
    #####:  256:            final = "mp";
    #####:  257:        } else if (!strcmp(final, "j")) {
    #####:  258:            final = "m";
        -:  259:        }
        -:  260:
        -:  261:    }
        -:  262:
        -:  263:    /* THL/MPS2 s/sh/c/ch/j :
        -:  264:     * s-  + ー/ㄩ, s-  is ㄒ, not ㄙ (THL/Tongyong)
        -:  265:     * sh- + ー/ㄩ, sh- is ㄒ, not ㄕ (MPS2)
        -:  266:     * c-  + ー/ㄩ, c-  is ㄑ, not ㄘ (Tongyong)
        -:  267:     * ch- + ㄧ/ㄩ, ch- is ㄑ, not ㄔ (THL)
        -:  268:     * j-  + other than ー/ㄩ, j-  is ㄓ, not ㄐ (MPS2)
        -:  269:     */
        -:  270:
    #####:  271:    if (final == strstr(final, "u") || final == strstr(final, "m")) {
    #####:  272:        if (!strcmp(initial, "n")) {
    #####:  273:            initial = "v";
    #####:  274:        } else if (!strcmp(initial, "g")) {
    #####:  275:            initial = "v";
    #####:  276:        } else if (!strcmp(initial, "h")) {
    #####:  277:            initial = "f";
    #####:  278:        } else if (!strcmp(initial, "t")) {
    #####:  279:            initial = "f";
        -:  280:        }
        -:  281:    } else {
    #####:  282:        if (!strcmp(initial, "r")) {
    #####:  283:            initial = "5";
        -:  284:        }
        -:  285:    }
        -:  286:
        -:  287:    /* THL supplemental set
        -:  288:     * ㄅ/ㄆ/ㄇ/ㄈ + -ㄨㄥ, -ㄨㄥ is another reading of -ㄥ
        -:  289:     * ㄅ/ㄆ/ㄇ/ㄈ + -ㄨㄛ, -ㄨㄛ is another reading of -ㄛ
        -:  290:     */
    #####:  291:    if (!strcmp(initial, "1") || !strcmp(initial, "q") || !strcmp(initial, "a") || !strcmp(initial, "z")) {
        -:  292:
    #####:  293:        if (!strcmp(final, "ji")) {
    #####:  294:            final = "i";
    #####:  295:        } else if (!strcmp(final, "j/")) {
    #####:  296:            final = "/";
        -:  297:        }
        -:  298:
        -:  299:    }
        -:  300:
    #####:  301:    sprintf(bopomofoKeySeq, "%s%s", initial, final);
    #####:  302:    strcpy(bopomofoKeySeqAlt, bopomofoKeySeq);
    #####:  303:    return 0;
        -:  304:}
