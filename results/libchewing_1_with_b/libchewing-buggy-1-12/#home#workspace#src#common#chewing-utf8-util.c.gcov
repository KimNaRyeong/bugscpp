        -:    0:Source:/home/workspace/src/common/chewing-utf8-util.c
        -:    1:/**
        -:    2: * chewing-utf8-util.c
        -:    3: *
        -:    4: * Copyright (c) 2005, 2006, 2012-2014
        -:    5: *	libchewing Core Team. See ChangeLog for details.
        -:    6: *
        -:    7: * See the file "COPYING" for information on usage and redistribution
        -:    8: * of this file.
        -:    9: */
        -:   10:
        -:   11:#include <stdio.h>
        -:   12:#include <string.h>
        -:   13:#include "chewing-utf8-util.h"
        -:   14:
        -:   15:/* Table of UTF-8 length */
        -:   16:static const char utf8len_tab[256] = {
        -:   17:    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        -:   18:    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        -:   19:    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        -:   20:    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        -:   21:    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,     /*bogus */
        -:   22:    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,     /*bogus */
        -:   23:    2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
        -:   24:    3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 6, 6, 1, 1,
        -:   25:};
        -:   26:
        -:   27:/* Return length of UTF-8 string */
      335:   28:int ueStrLen(const char *str)
        -:   29:{
      335:   30:    int length = 0;
      335:   31:    const char *strptr = str;
        -:   32:
     2659:   33:    while (strptr[0] != '\0') {
     2324:   34:        strptr += ueBytesFromChar(strptr[0]);
     2324:   35:        ++length;
        -:   36:    }
      335:   37:    return length;
        -:   38:}
        -:   39:
        -:   40:/* Return bytes of a UTF-8 character */
    12520:   41:int ueBytesFromChar(unsigned char b)
        -:   42:{
    12520:   43:    return utf8len_tab[b];
        -:   44:}
        -:   45:
        -:   46:/* Return bytes of a UTF-8 string until n position */
     2525:   47:int ueStrNBytes(const char *str, int n)
        -:   48:{
     2525:   49:    int i = 0, len = 0;
     2525:   50:    const char *iter = str;
        -:   51:
     5851:   52:    for (i = 0; i < n; i++) {
     3326:   53:        len += ueBytesFromChar(iter[len]);
        -:   54:    }
     2525:   55:    return len;
        -:   56:}
        -:   57:
        -:   58:/* Return how many bytes was copied */
     2435:   59:int ueStrNCpy(char dest[], const char *src, size_t n, int end)
        -:   60:{
     2435:   61:    int len = 0;
        -:   62:
     2435:   63:    len = ueStrNBytes(src, n);
     2435:   64:    memcpy(dest, src, len);
     2435:   65:    if (end == STRNCPY_CLOSE)
     2290:   66:        dest[len] = '\0';
     2435:   67:    return len;
        -:   68:}
        -:   69:
      265:   70:const char *ueConstStrSeek(const char *src, size_t n)
        -:   71:{
      265:   72:    size_t i = 0;
      265:   73:    const char *iter = src;
        -:   74:
     5105:   75:    for (i = 0; i < n; i++) {
     4840:   76:        iter += ueBytesFromChar(iter[0]);
        -:   77:    }
      265:   78:    return iter;
        -:   79:}
        -:   80:
      457:   81:char *ueStrSeek(char *src, size_t n)
        -:   82:{
      457:   83:    size_t i = 0;
      457:   84:    char *iter = src;
        -:   85:
      620:   86:    for (i = 0; i < n; i++) {
      163:   87:        iter += ueBytesFromChar(iter[0]);
        -:   88:    }
      457:   89:    return iter;
        -:   90:}
        -:   91:
        -:   92:/* Locate a UTF-8 substring from UTF-8 string */
    #####:   93:const char *ueStrStr(const char *str, size_t lstr, const char *substr, size_t lsub)
        -:   94:{
    #####:   95:    const char *p = str;
        -:   96:    size_t ub;
        -:   97:
    #####:   98:    if (lstr < lsub)
    #####:   99:        return NULL;
    #####:  100:    ub = lstr - lsub;
    #####:  101:    for (; (size_t) (p - str) <= ub; p++) {
    #####:  102:        if (!strncmp(p, substr, lsub))
    #####:  103:            return p;
        -:  104:    }
    #####:  105:    return NULL;
        -:  106:}
