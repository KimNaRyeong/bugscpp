        -:    0:Source:/home/workspace/tests/unit-core/test-vm-throw.c
        -:    0:Programs:299
        -:    1:/* Copyright JS Foundation and other contributors, http://js.foundation
        -:    2: *
        -:    3: * Licensed under the Apache License, Version 2.0 (the "License");
        -:    4: * you may not use this file except in compliance with the License.
        -:    5: * You may obtain a copy of the License at
        -:    6: *
        -:    7: *     http://www.apache.org/licenses/LICENSE-2.0
        -:    8: *
        -:    9: * Unless required by applicable law or agreed to in writing, software
        -:   10: * distributed under the License is distributed on an "AS IS" BASIS
        -:   11: * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
        -:   12: * See the License for the specific language governing permissions and
        -:   13: * limitations under the License.
        -:   14: */
        -:   15:
        -:   16:#include "jerryscript.h"
        -:   17:
        -:   18:#include "config.h"
        -:   19:#include "test-common.h"
        -:   20:
        -:   21:static int mode = 0;
        -:   22:static int counter = 0;
        -:   23:
        -:   24:static void
    #####:   25:vm_throw_callback (const jerry_value_t error_value, /**< captured error */
        -:   26:                   void *user_p) /**< user pointer */
        -:   27:{
    #####:   28:  TEST_ASSERT (user_p == (void *) &mode);
    #####:   29:  counter++;
        -:   30:
    #####:   31:  switch (mode)
        -:   32:  {
    #####:   33:    case 0:
        -:   34:    {
    #####:   35:      TEST_ASSERT (counter == 1);
    #####:   36:      TEST_ASSERT (jerry_value_is_number (error_value) && jerry_value_as_number (error_value) == -5.6);
        -:   37:      break;
        -:   38:    }
    #####:   39:    case 1:
        -:   40:    {
    #####:   41:      TEST_ASSERT (counter == 1);
    #####:   42:      TEST_ASSERT (jerry_value_is_null (error_value));
        -:   43:      break;
        -:   44:    }
    #####:   45:    case 2:
        -:   46:    {
        -:   47:      jerry_char_t string_buf[2];
    #####:   48:      jerry_size_t size = sizeof (string_buf);
        -:   49:
    #####:   50:      string_buf[0] = '\0';
    #####:   51:      string_buf[1] = '\0';
        -:   52:
    #####:   53:      TEST_ASSERT (counter >= 1 && counter <= 3);
    #####:   54:      TEST_ASSERT (jerry_value_is_string (error_value));
    #####:   55:      TEST_ASSERT (jerry_string_size (error_value, JERRY_ENCODING_CESU8) == size);
    #####:   56:      TEST_ASSERT (jerry_string_to_buffer (error_value, JERRY_ENCODING_CESU8, string_buf, size) == size);
    #####:   57:      TEST_ASSERT (string_buf[0] == 'e' && string_buf[1] == (char) ('0' + counter));
        -:   58:      break;
        -:   59:    }
    #####:   60:    case 3:
        -:   61:    {
    #####:   62:      TEST_ASSERT (counter == 1);
    #####:   63:      TEST_ASSERT (jerry_error_type (error_value) == JERRY_ERROR_RANGE);
        -:   64:      break;
        -:   65:    }
    #####:   66:    case 4:
        -:   67:    {
    #####:   68:      TEST_ASSERT (mode == 4);
    #####:   69:      TEST_ASSERT (counter >= 1 && counter <= 2);
        -:   70:
    #####:   71:      jerry_error_t error = (counter == 1) ? JERRY_ERROR_REFERENCE : JERRY_ERROR_TYPE;
    #####:   72:      TEST_ASSERT (jerry_error_type (error_value) == error);
        -:   73:      break;
        -:   74:    }
    #####:   75:    case 5:
        -:   76:    case 6:
        -:   77:    {
    #####:   78:      TEST_ASSERT (counter >= 1 && counter <= 2);
    #####:   79:      TEST_ASSERT (jerry_value_is_false (error_value));
        -:   80:      break;
        -:   81:    }
    #####:   82:    default:
        -:   83:    {
    #####:   84:      TEST_ASSERT (mode == 8 || mode == 9);
    #####:   85:      TEST_ASSERT (counter == 1);
    #####:   86:      TEST_ASSERT (jerry_value_is_true (error_value));
        -:   87:      break;
        -:   88:    }
        -:   89:  }
    #####:   90:} /* vm_throw_callback */
        -:   91:
        -:   92:static jerry_value_t
    #####:   93:native_handler (const jerry_call_info_t *call_info_p, /**< call info */
        -:   94:                const jerry_value_t args_p[], /**< arguments */
        -:   95:                const jerry_length_t args_count) /**< arguments length */
        -:   96:{
        -:   97:  (void) call_info_p;
        -:   98:  (void) args_p;
    #####:   99:  TEST_ASSERT (args_count == 0);
        -:  100:
    #####:  101:  if (mode == 7)
        -:  102:  {
    #####:  103:    jerry_value_t result = jerry_throw_sz (JERRY_ERROR_COMMON, "Error!");
        -:  104:
    #####:  105:    TEST_ASSERT (!jerry_exception_is_captured (result));
    #####:  106:    jerry_exception_allow_capture (result, false);
    #####:  107:    TEST_ASSERT (jerry_exception_is_captured (result));
        -:  108:    return result;
        -:  109:  }
        -:  110:
    #####:  111:  jerry_char_t source[] = TEST_STRING_LITERAL ("throw false");
    #####:  112:  jerry_value_t result = jerry_eval (source, sizeof (source) - 1, JERRY_PARSE_NO_OPTS);
        -:  113:
    #####:  114:  TEST_ASSERT (jerry_exception_is_captured (result));
        -:  115:
    #####:  116:  if (mode == 6)
        -:  117:  {
    #####:  118:    jerry_exception_allow_capture (result, true);
    #####:  119:    TEST_ASSERT (!jerry_exception_is_captured (result));
        -:  120:  }
        -:  121:  return result;
        -:  122:} /* native_handler */
        -:  123:
        -:  124:static void
    #####:  125:do_eval (const char *script_p, /**< script to evaluate */
        -:  126:         bool should_throw) /**< script throws an error */
        -:  127:{
    #####:  128:  jerry_value_t result = jerry_eval ((const jerry_char_t *) script_p, strlen (script_p), JERRY_PARSE_NO_OPTS);
    #####:  129:  TEST_ASSERT (jerry_value_is_exception (result) == should_throw);
    #####:  130:  jerry_value_free (result);
    #####:  131:} /* do_eval */
        -:  132:
        -:  133:int
    #####:  134:main (void)
        -:  135:{
    #####:  136:  TEST_INIT ();
        -:  137:
        -:  138:  /* Test stopping an infinite loop. */
    #####:  139:  if (!jerry_feature_enabled (JERRY_FEATURE_VM_THROW))
        -:  140:  {
        -:  141:    return 0;
        -:  142:  }
        -:  143:
    #####:  144:  jerry_init (JERRY_INIT_EMPTY);
        -:  145:
    #####:  146:  jerry_on_throw (vm_throw_callback, (void *) &mode);
        -:  147:
    #####:  148:  mode = 0;
    #####:  149:  counter = 0;
    #####:  150:  do_eval (TEST_STRING_LITERAL ("throw -5.6"), true);
    #####:  151:  TEST_ASSERT (counter == 1);
        -:  152:
    #####:  153:  mode = 1;
    #####:  154:  counter = 0;
    #####:  155:  do_eval (TEST_STRING_LITERAL ("function f() { throw null }\n"
        -:  156:                                "function g() { f() }\n"
        -:  157:                                "g()\n"),
        -:  158:           true);
    #####:  159:  TEST_ASSERT (counter == 1);
        -:  160:
    #####:  161:  mode = 2;
    #####:  162:  counter = 0;
    #####:  163:  do_eval (TEST_STRING_LITERAL ("function f() { throw 'e1' }\n"
        -:  164:                                "function g() { try { f() } catch (e) { throw 'e2' } }\n"
        -:  165:                                "try { g() } catch (e) { throw 'e3' }\n"),
        -:  166:           true);
    #####:  167:  TEST_ASSERT (counter == 3);
        -:  168:
    #####:  169:  mode = 3;
    #####:  170:  counter = 0;
    #####:  171:  do_eval (TEST_STRING_LITERAL ("function f() { throw new RangeError() }\n"
        -:  172:                                "function g() { try { f() } finally { } }\n"
        -:  173:                                "try { g() } finally { }\n"),
        -:  174:           true);
    #####:  175:  TEST_ASSERT (counter == 1);
        -:  176:
    #####:  177:  mode = 4;
    #####:  178:  counter = 0;
    #####:  179:  do_eval (TEST_STRING_LITERAL ("function f() { unresolved }\n"
        -:  180:                                "function g() { try { f() } finally { null.member } }\n"
        -:  181:                                "try { g() } finally { }\n"),
        -:  182:           true);
    #####:  183:  TEST_ASSERT (counter == 2);
        -:  184:
        -:  185:  /* Native functions may trigger the call twice: */
    #####:  186:  jerry_value_t global_object_value = jerry_current_realm ();
    #####:  187:  jerry_value_t function_value = jerry_function_external (native_handler);
    #####:  188:  jerry_value_t function_name_value = jerry_string_sz ("native");
        -:  189:
    #####:  190:  jerry_value_free (jerry_object_set (global_object_value, function_name_value, function_value));
    #####:  191:  jerry_value_free (function_name_value);
    #####:  192:  jerry_value_free (function_value);
    #####:  193:  jerry_value_free (global_object_value);
        -:  194:
    #####:  195:  mode = 5;
    #####:  196:  counter = 0;
    #####:  197:  do_eval (TEST_STRING_LITERAL ("native()\n"), true);
    #####:  198:  TEST_ASSERT (counter == 1);
        -:  199:
    #####:  200:  mode = 6;
    #####:  201:  counter = 0;
    #####:  202:  do_eval (TEST_STRING_LITERAL ("native()\n"), true);
    #####:  203:  TEST_ASSERT (counter == 2);
        -:  204:
    #####:  205:  mode = 7;
    #####:  206:  counter = 0;
    #####:  207:  do_eval (TEST_STRING_LITERAL ("native()\n"), true);
    #####:  208:  TEST_ASSERT (counter == 0);
        -:  209:
        -:  210:  /* Built-in functions should not trigger the call twice: */
    #####:  211:  mode = 8;
    #####:  212:  counter = 0;
    #####:  213:  do_eval (TEST_STRING_LITERAL ("function f() { eval('eval(\\'throw true\\')') }\n"
        -:  214:                                "f()\n"),
        -:  215:           true);
    #####:  216:  TEST_ASSERT (counter == 1);
        -:  217:
    #####:  218:  mode = 9;
    #####:  219:  counter = 0;
    #####:  220:  do_eval (TEST_STRING_LITERAL ("function f() { [1].map(function() { throw true }) }\n"
        -:  221:                                "f()\n"),
        -:  222:           true);
    #####:  223:  TEST_ASSERT (counter == 1);
        -:  224:
    #####:  225:  jerry_value_t value = jerry_object ();
    #####:  226:  TEST_ASSERT (!jerry_exception_is_captured (value));
    #####:  227:  jerry_exception_allow_capture (value, false);
    #####:  228:  TEST_ASSERT (!jerry_exception_is_captured (value));
    #####:  229:  jerry_value_free (value);
        -:  230:
    #####:  231:  jerry_cleanup ();
    #####:  232:  return 0;
        -:  233:} /* main */
