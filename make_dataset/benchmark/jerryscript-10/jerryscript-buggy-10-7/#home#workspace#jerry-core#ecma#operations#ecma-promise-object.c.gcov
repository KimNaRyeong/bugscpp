        -:    0:Source:/home/workspace/jerry-core/ecma/operations/ecma-promise-object.c
        -:    0:Programs:299
        -:    1:/* Copyright JS Foundation and other contributors, http://js.foundation
        -:    2: *
        -:    3: * Licensed under the Apache License, Version 2.0 (the "License");
        -:    4: * you may not use this file except in compliance with the License.
        -:    5: * You may obtain a copy of the License at
        -:    6: *
        -:    7: *     http://www.apache.org/licenses/LICENSE-2.0
        -:    8: *
        -:    9: * Unless required by applicable law or agreed to in writing, software
        -:   10: * distributed under the License is distributed on an "AS IS" BASIS
        -:   11: * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
        -:   12: * See the License for the specific language governing permissions and
        -:   13: * limitations under the License.
        -:   14: */
        -:   15:
        -:   16:#include "ecma-promise-object.h"
        -:   17:
        -:   18:#include "ecma-alloc.h"
        -:   19:#include "ecma-array-object.h"
        -:   20:#include "ecma-boolean-object.h"
        -:   21:#include "ecma-builtin-handlers.h"
        -:   22:#include "ecma-builtins.h"
        -:   23:#include "ecma-exceptions.h"
        -:   24:#include "ecma-function-object.h"
        -:   25:#include "ecma-gc.h"
        -:   26:#include "ecma-globals.h"
        -:   27:#include "ecma-helpers.h"
        -:   28:#include "ecma-jobqueue.h"
        -:   29:#include "ecma-objects-general.h"
        -:   30:#include "ecma-objects.h"
        -:   31:
        -:   32:#include "jcontext.h"
        -:   33:
        -:   34:#if JERRY_ESNEXT
        -:   35:
        -:   36:/** \addtogroup ecma ECMA
        -:   37: * @{
        -:   38: *
        -:   39: * \addtogroup ecmapromiseobject ECMA Promise object related routines
        -:   40: * @{
        -:   41: */
        -:   42:
        -:   43:/**
        -:   44: * Check if an object is promise.
        -:   45: *
        -:   46: * @return true - if the object is a promise.
        -:   47: *         false - otherwise.
        -:   48: */
        -:   49:extern inline bool JERRY_ATTR_ALWAYS_INLINE
    #####:   50:ecma_is_promise (ecma_object_t *obj_p) /**< points to object */
        -:   51:{
    #####:   52:  return ecma_object_class_is (obj_p, ECMA_OBJECT_CLASS_PROMISE);
        -:   53:} /* ecma_is_promise */
        -:   54:
        -:   55:/**
        -:   56: * Get the result of the promise.
        -:   57: *
        -:   58: * @return ecma value of the promise result.
        -:   59: *         Returned value must be freed with ecma_free_value
        -:   60: */
        -:   61:ecma_value_t
    #####:   62:ecma_promise_get_result (ecma_object_t *obj_p) /**< points to promise object */
        -:   63:{
    #####:   64:  JERRY_ASSERT (ecma_is_promise (obj_p));
        -:   65:
    #####:   66:  ecma_extended_object_t *ext_object_p = (ecma_extended_object_t *) obj_p;
        -:   67:
    #####:   68:  return ecma_copy_value (ext_object_p->u.cls.u3.value);
        -:   69:} /* ecma_promise_get_result */
        -:   70:
        -:   71:/**
        -:   72: * Set the PromiseResult of promise.
        -:   73: */
        -:   74:static inline void JERRY_ATTR_ALWAYS_INLINE
        -:   75:ecma_promise_set_result (ecma_object_t *obj_p, /**< points to promise object */
        -:   76:                         ecma_value_t result) /**< the result value */
        -:   77:{
    #####:   78:  JERRY_ASSERT (ecma_is_promise (obj_p));
        -:   79:
    #####:   80:  ecma_extended_object_t *ext_object_p = (ecma_extended_object_t *) obj_p;
        -:   81:
    #####:   82:  JERRY_ASSERT (ext_object_p->u.cls.u3.value == ECMA_VALUE_UNDEFINED);
        -:   83:
    #####:   84:  ext_object_p->u.cls.u3.value = result;
        -:   85:} /* ecma_promise_set_result */
        -:   86:
        -:   87:/**
        -:   88: * Get the PromiseState of promise.
        -:   89: *
        -:   90: * @return the state's enum value
        -:   91: */
        -:   92:uint8_t
    #####:   93:ecma_promise_get_flags (ecma_object_t *obj_p) /**< points to promise object */
        -:   94:{
    #####:   95:  JERRY_ASSERT (ecma_is_promise (obj_p));
        -:   96:
    #####:   97:  return ((ecma_extended_object_t *) obj_p)->u.cls.u1.promise_flags;
        -:   98:} /* ecma_promise_get_flags */
        -:   99:
        -:  100:/**
        -:  101: * Set the PromiseState of promise.
        -:  102: */
        -:  103:static inline void JERRY_ATTR_ALWAYS_INLINE
        -:  104:ecma_promise_set_state (ecma_object_t *obj_p, /**< points to promise object */
        -:  105:                        bool is_fulfilled) /**< new flags */
        -:  106:{
    #####:  107:  JERRY_ASSERT (ecma_is_promise (obj_p));
    #####:  108:  JERRY_ASSERT (ecma_promise_get_flags (obj_p) & ECMA_PROMISE_IS_PENDING);
        -:  109:
    #####:  110:  uint8_t flags_to_invert =
        -:  111:    (is_fulfilled ? (ECMA_PROMISE_IS_PENDING | ECMA_PROMISE_IS_FULFILLED) : ECMA_PROMISE_IS_PENDING);
        -:  112:
    #####:  113:  ((ecma_extended_object_t *) obj_p)->u.cls.u1.promise_flags ^= flags_to_invert;
        -:  114:} /* ecma_promise_set_state */
        -:  115:
        -:  116:/**
        -:  117: * Take a collection of Reactions and enqueue a new PromiseReactionJob for each Reaction.
        -:  118: *
        -:  119: * See also: ES2015 25.4.1.8
        -:  120: */
        -:  121:static void
    #####:  122:ecma_promise_trigger_reactions (ecma_collection_t *reactions, /**< lists of reactions */
        -:  123:                                ecma_value_t value, /**< value for resolve or reject */
        -:  124:                                bool is_reject) /**< true if promise is rejected, false otherwise */
        -:  125:{
    #####:  126:  ecma_value_t *buffer_p = reactions->buffer_p;
    #####:  127:  ecma_value_t *buffer_end_p = buffer_p + reactions->item_count;
        -:  128:
    #####:  129:  while (buffer_p < buffer_end_p)
        -:  130:  {
    #####:  131:    ecma_value_t object_with_tag = *buffer_p++;
    #####:  132:    ecma_object_t *object_p = ECMA_GET_NON_NULL_POINTER_FROM_POINTER_TAG (ecma_object_t, object_with_tag);
    #####:  133:    ecma_value_t object = ecma_make_object_value (object_p);
        -:  134:
    #####:  135:    if (JMEM_CP_GET_THIRD_BIT_FROM_POINTER_TAG (object_with_tag))
        -:  136:    {
    #####:  137:      ecma_enqueue_promise_async_reaction_job (object, value, is_reject);
    #####:  138:      continue;
        -:  139:    }
        -:  140:
    #####:  141:    if (!is_reject)
        -:  142:    {
    #####:  143:      ecma_value_t handler = ECMA_VALUE_TRUE;
        -:  144:
    #####:  145:      if (JMEM_CP_GET_FIRST_BIT_FROM_POINTER_TAG (object_with_tag))
        -:  146:      {
    #####:  147:        handler = *buffer_p++;
        -:  148:      }
        -:  149:
    #####:  150:      ecma_enqueue_promise_reaction_job (object, handler, value);
        -:  151:    }
    #####:  152:    else if (JMEM_CP_GET_FIRST_BIT_FROM_POINTER_TAG (object_with_tag))
        -:  153:    {
    #####:  154:      buffer_p++;
        -:  155:    }
        -:  156:
    #####:  157:    if (is_reject)
        -:  158:    {
    #####:  159:      ecma_value_t handler = ECMA_VALUE_FALSE;
        -:  160:
    #####:  161:      if (JMEM_CP_GET_SECOND_BIT_FROM_POINTER_TAG (object_with_tag))
        -:  162:      {
    #####:  163:        handler = *buffer_p++;
        -:  164:      }
        -:  165:
    #####:  166:      ecma_enqueue_promise_reaction_job (object, handler, value);
        -:  167:    }
    #####:  168:    else if (JMEM_CP_GET_SECOND_BIT_FROM_POINTER_TAG (object_with_tag))
        -:  169:    {
    #####:  170:      buffer_p++;
        -:  171:    }
        -:  172:  }
    #####:  173:} /* ecma_promise_trigger_reactions */
        -:  174:
        -:  175:/**
        -:  176: * Checks whether a resolver is called before.
        -:  177: *
        -:  178: * @return true if it was called before, false otherwise
        -:  179: */
        -:  180:static inline bool JERRY_ATTR_ALWAYS_INLINE
        -:  181:ecma_is_resolver_already_called (ecma_object_t *promise_obj_p) /**< promise */
        -:  182:{
    #####:  183:  return (ecma_promise_get_flags (promise_obj_p) & ECMA_PROMISE_ALREADY_RESOLVED) != 0;
        -:  184:} /* ecma_is_resolver_already_called */
        -:  185:
        -:  186:/**
        -:  187: * Reject a Promise with a reason.
        -:  188: *
        -:  189: * See also: ES2015 25.4.1.7
        -:  190: */
        -:  191:void
    #####:  192:ecma_reject_promise (ecma_value_t promise, /**< promise */
        -:  193:                     ecma_value_t reason) /**< reason for reject */
        -:  194:{
    #####:  195:  ecma_object_t *obj_p = ecma_get_object_from_value (promise);
        -:  196:
    #####:  197:  JERRY_ASSERT (ecma_promise_get_flags (obj_p) & ECMA_PROMISE_IS_PENDING);
        -:  198:
        -:  199:#if JERRY_PROMISE_CALLBACK
    #####:  200:  if (JERRY_UNLIKELY (JERRY_CONTEXT (promise_callback_filters) & JERRY_PROMISE_EVENT_FILTER_REJECT))
        -:  201:  {
        -:  202:    JERRY_ASSERT (JERRY_CONTEXT (promise_callback) != NULL);
    #####:  203:    JERRY_CONTEXT (promise_callback)
        -:  204:    (JERRY_PROMISE_EVENT_REJECT, promise, reason, JERRY_CONTEXT (promise_callback_user_p));
        -:  205:  }
        -:  206:#endif /* JERRY_PROMISE_CALLBACK */
        -:  207:
    #####:  208:  ecma_promise_set_state (obj_p, false);
    #####:  209:  ecma_promise_set_result (obj_p, ecma_copy_value_if_not_object (reason));
    #####:  210:  ecma_promise_object_t *promise_p = (ecma_promise_object_t *) obj_p;
        -:  211:
        -:  212:  /* GC can be triggered by ecma_new_collection so freeing the collection
        -:  213:     first and creating a new one might cause a heap after use event. */
    #####:  214:  ecma_collection_t *reactions = promise_p->reactions;
        -:  215:
        -:  216:  /* Fulfill reactions will never be triggered. */
    #####:  217:  ecma_promise_trigger_reactions (reactions, reason, true);
        -:  218:
        -:  219:#if JERRY_PROMISE_CALLBACK
    #####:  220:  if (reactions->item_count == 0)
        -:  221:  {
    #####:  222:    ((ecma_extended_object_t *) obj_p)->u.cls.u1.promise_flags |= ECMA_PROMISE_UNHANDLED_REJECT;
        -:  223:
    #####:  224:    if (JERRY_UNLIKELY (JERRY_CONTEXT (promise_callback_filters) & JERRY_PROMISE_EVENT_FILTER_ERROR))
        -:  225:    {
        -:  226:      JERRY_ASSERT (JERRY_CONTEXT (promise_callback) != NULL);
    #####:  227:      JERRY_CONTEXT (promise_callback)
        -:  228:      (JERRY_PROMISE_EVENT_REJECT_WITHOUT_HANDLER, promise, reason, JERRY_CONTEXT (promise_callback_user_p));
        -:  229:    }
        -:  230:  }
        -:  231:#endif /* JERRY_PROMISE_CALLBACK */
        -:  232:
    #####:  233:  promise_p->reactions = ecma_new_collection ();
        -:  234:
    #####:  235:  ecma_collection_destroy (reactions);
    #####:  236:} /* ecma_reject_promise */
        -:  237:
        -:  238:/**
        -:  239: * Fulfill a Promise with a value.
        -:  240: *
        -:  241: * See also: ES2015 25.4.1.4
        -:  242: */
        -:  243:void
    #####:  244:ecma_fulfill_promise (ecma_value_t promise, /**< promise */
        -:  245:                      ecma_value_t value) /**< fulfilled value */
        -:  246:{
    #####:  247:  ecma_object_t *obj_p = ecma_get_object_from_value (promise);
        -:  248:
    #####:  249:  JERRY_ASSERT (ecma_promise_get_flags (obj_p) & ECMA_PROMISE_IS_PENDING);
        -:  250:
    #####:  251:  if (promise == value)
        -:  252:  {
    #####:  253:    ecma_raise_type_error (ECMA_ERR_PROMISE_RESOLVE_ITSELF);
    #####:  254:    ecma_value_t exception = jcontext_take_exception ();
    #####:  255:    ecma_reject_promise (promise, exception);
    #####:  256:    ecma_free_value (exception);
    #####:  257:    return;
        -:  258:  }
        -:  259:
    #####:  260:  if (ecma_is_value_object (value))
        -:  261:  {
    #####:  262:    ecma_value_t then = ecma_op_object_get_by_magic_id (ecma_get_object_from_value (value), LIT_MAGIC_STRING_THEN);
        -:  263:
    #####:  264:    if (ECMA_IS_VALUE_ERROR (then))
        -:  265:    {
    #####:  266:      then = jcontext_take_exception ();
    #####:  267:      ecma_reject_promise (promise, then);
    #####:  268:      ecma_free_value (then);
    #####:  269:      return;
        -:  270:    }
        -:  271:
    #####:  272:    if (ecma_op_is_callable (then))
        -:  273:    {
    #####:  274:      ecma_enqueue_promise_resolve_thenable_job (promise, value, then);
    #####:  275:      ecma_free_value (then);
    #####:  276:      return;
        -:  277:    }
        -:  278:
    #####:  279:    ecma_free_value (then);
        -:  280:  }
        -:  281:
        -:  282:#if JERRY_PROMISE_CALLBACK
    #####:  283:  if (JERRY_UNLIKELY (JERRY_CONTEXT (promise_callback_filters) & JERRY_PROMISE_EVENT_FILTER_RESOLVE))
        -:  284:  {
        -:  285:    JERRY_ASSERT (JERRY_CONTEXT (promise_callback) != NULL);
    #####:  286:    JERRY_CONTEXT (promise_callback)
        -:  287:    (JERRY_PROMISE_EVENT_RESOLVE, promise, value, JERRY_CONTEXT (promise_callback_user_p));
        -:  288:  }
        -:  289:#endif /* JERRY_PROMISE_CALLBACK */
        -:  290:
    #####:  291:  ecma_promise_set_state (obj_p, true);
    #####:  292:  ecma_promise_set_result (obj_p, ecma_copy_value_if_not_object (value));
    #####:  293:  ecma_promise_object_t *promise_p = (ecma_promise_object_t *) obj_p;
        -:  294:
        -:  295:  /* GC can be triggered by ecma_new_collection so freeing the collection
        -:  296:     first and creating a new one might cause a heap after use event. */
    #####:  297:  ecma_collection_t *reactions = promise_p->reactions;
        -:  298:
        -:  299:  /* Reject reactions will never be triggered. */
    #####:  300:  ecma_promise_trigger_reactions (reactions, value, false);
        -:  301:
    #####:  302:  promise_p->reactions = ecma_new_collection ();
        -:  303:
    #####:  304:  ecma_collection_destroy (reactions);
        -:  305:} /* ecma_fulfill_promise */
        -:  306:
        -:  307:/**
        -:  308: * Reject a Promise with a reason. Sanity checks are performed before the reject.
        -:  309: *
        -:  310: * See also: ES2015 25.4.1.3.1
        -:  311: *
        -:  312: * @return ecma value of undefined.
        -:  313: */
        -:  314:ecma_value_t
    #####:  315:ecma_reject_promise_with_checks (ecma_value_t promise, /**< promise */
        -:  316:                                 ecma_value_t reason) /**< reason for reject */
        -:  317:{
        -:  318:  /* 1. */
    #####:  319:  ecma_object_t *promise_obj_p = ecma_get_object_from_value (promise);
    #####:  320:  JERRY_ASSERT (ecma_is_promise (promise_obj_p));
        -:  321:
        -:  322:  /* 3., 4. */
    #####:  323:  if (JERRY_UNLIKELY (ecma_is_resolver_already_called (promise_obj_p)))
        -:  324:  {
        -:  325:#if JERRY_PROMISE_CALLBACK
    #####:  326:    if (JERRY_UNLIKELY (JERRY_CONTEXT (promise_callback_filters) & JERRY_PROMISE_EVENT_FILTER_ERROR))
        -:  327:    {
        -:  328:      JERRY_ASSERT (JERRY_CONTEXT (promise_callback) != NULL);
    #####:  329:      JERRY_CONTEXT (promise_callback)
        -:  330:      (JERRY_PROMISE_EVENT_REJECT_FULFILLED, promise, reason, JERRY_CONTEXT (promise_callback_user_p));
        -:  331:    }
        -:  332:#endif /* JERRY_PROMISE_CALLBACK */
        -:  333:
    #####:  334:    return ECMA_VALUE_UNDEFINED;
        -:  335:  }
        -:  336:
        -:  337:  /* 5. */
    #####:  338:  ((ecma_extended_object_t *) promise_obj_p)->u.cls.u1.promise_flags |= ECMA_PROMISE_ALREADY_RESOLVED;
        -:  339:
        -:  340:  /* 6. */
    #####:  341:  ecma_reject_promise (promise, reason);
    #####:  342:  return ECMA_VALUE_UNDEFINED;
        -:  343:} /* ecma_reject_promise_with_checks */
        -:  344:
        -:  345:/**
        -:  346: * Fulfill a Promise with a value. Sanity checks are performed before the resolve.
        -:  347: *
        -:  348: * See also: ES2015 25.4.1.3.2
        -:  349: *
        -:  350: * @return ecma value of undefined.
        -:  351: */
        -:  352:ecma_value_t
    #####:  353:ecma_fulfill_promise_with_checks (ecma_value_t promise, /**< promise */
        -:  354:                                  ecma_value_t value) /**< fulfilled value */
        -:  355:{
        -:  356:  /* 1. */
    #####:  357:  ecma_object_t *promise_obj_p = ecma_get_object_from_value (promise);
    #####:  358:  JERRY_ASSERT (ecma_is_promise (promise_obj_p));
        -:  359:
        -:  360:  /* 3., 4. */
    #####:  361:  if (JERRY_UNLIKELY (ecma_is_resolver_already_called (promise_obj_p)))
        -:  362:  {
        -:  363:#if JERRY_PROMISE_CALLBACK
    #####:  364:    if (JERRY_UNLIKELY (JERRY_CONTEXT (promise_callback_filters) & JERRY_PROMISE_EVENT_FILTER_ERROR))
        -:  365:    {
        -:  366:      JERRY_ASSERT (JERRY_CONTEXT (promise_callback) != NULL);
    #####:  367:      JERRY_CONTEXT (promise_callback)
        -:  368:      (JERRY_PROMISE_EVENT_RESOLVE_FULFILLED, promise, value, JERRY_CONTEXT (promise_callback_user_p));
        -:  369:    }
        -:  370:#endif /* JERRY_PROMISE_CALLBACK */
        -:  371:
    #####:  372:    return ECMA_VALUE_UNDEFINED;
        -:  373:  }
        -:  374:
        -:  375:  /* 5. */
    #####:  376:  ((ecma_extended_object_t *) promise_obj_p)->u.cls.u1.promise_flags |= ECMA_PROMISE_ALREADY_RESOLVED;
        -:  377:
    #####:  378:  ecma_fulfill_promise (promise, value);
    #####:  379:  return ECMA_VALUE_UNDEFINED;
        -:  380:} /* ecma_fulfill_promise_with_checks */
        -:  381:
        -:  382:/**
        -:  383: * Native handler for Promise Reject Function.
        -:  384: *
        -:  385: * @return ecma value of undefined.
        -:  386: */
        -:  387:ecma_value_t
    #####:  388:ecma_promise_reject_handler (ecma_object_t *function_obj_p, /**< function object */
        -:  389:                             const ecma_value_t args_p[], /**< argument list */
        -:  390:                             const uint32_t args_count) /**< argument number */
        -:  391:{
    #####:  392:  ecma_promise_resolver_t *function_p = (ecma_promise_resolver_t *) function_obj_p;
        -:  393:
    #####:  394:  ecma_value_t reject_value = (args_count == 0) ? ECMA_VALUE_UNDEFINED : args_p[0];
    #####:  395:  return ecma_reject_promise_with_checks (function_p->promise, reject_value);
        -:  396:} /* ecma_promise_reject_handler */
        -:  397:
        -:  398:/**
        -:  399: * Native handler for Promise Resolve Function.
        -:  400: *
        -:  401: * @return ecma value of undefined.
        -:  402: */
        -:  403:ecma_value_t
    #####:  404:ecma_promise_resolve_handler (ecma_object_t *function_obj_p, /**< function object */
        -:  405:                              const ecma_value_t args_p[], /**< argument list */
        -:  406:                              const uint32_t args_count) /**< argument number */
        -:  407:{
    #####:  408:  ecma_promise_resolver_t *function_p = (ecma_promise_resolver_t *) function_obj_p;
        -:  409:
    #####:  410:  ecma_value_t fulfilled_value = (args_count == 0) ? ECMA_VALUE_UNDEFINED : args_p[0];
    #####:  411:  return ecma_fulfill_promise_with_checks (function_p->promise, fulfilled_value);
        -:  412:} /* ecma_promise_resolve_handler */
        -:  413:
        -:  414:/**
        -:  415: * Helper function for PromiseCreateResolvingFunctions.
        -:  416: *
        -:  417: * See also: ES2015 25.4.1.3 2. - 7.
        -:  418: *
        -:  419: * @return pointer to the resolving function
        -:  420: */
        -:  421:static ecma_object_t *
    #####:  422:ecma_promise_create_resolving_function (ecma_object_t *promise_p, /**< Promise Object */
        -:  423:                                        ecma_native_handler_id_t id) /**< Callback handler */
        -:  424:{
    #####:  425:  ecma_object_t *func_obj_p = ecma_op_create_native_handler (id, sizeof (ecma_promise_resolver_t));
        -:  426:
    #####:  427:  ecma_promise_resolver_t *resolver_p = (ecma_promise_resolver_t *) func_obj_p;
    #####:  428:  resolver_p->promise = ecma_make_object_value (promise_p);
        -:  429:
    #####:  430:  return func_obj_p;
        -:  431:} /* ecma_promise_create_resolving_function */
        -:  432:
        -:  433:/**
        -:  434: * Helper function for running an executor.
        -:  435: *
        -:  436: * @return ecma value of the executor callable
        -:  437: *         Returned value must be freed with ecma_free_value
        -:  438: */
        -:  439:ecma_value_t
    #####:  440:ecma_promise_run_executor (ecma_object_t *promise_p, /**< Promise Object */
        -:  441:                           ecma_value_t executor, /**< executor function */
        -:  442:                           ecma_value_t this_value) /**< this value */
        -:  443:{
        -:  444:  ecma_object_t *resolve_func_p, *reject_func_p;
    #####:  445:  resolve_func_p = ecma_promise_create_resolving_function (promise_p, ECMA_NATIVE_HANDLER_PROMISE_RESOLVE);
    #####:  446:  reject_func_p = ecma_promise_create_resolving_function (promise_p, ECMA_NATIVE_HANDLER_PROMISE_REJECT);
        -:  447:
    #####:  448:  ecma_value_t argv[] = { ecma_make_object_value (resolve_func_p), ecma_make_object_value (reject_func_p) };
    #####:  449:  ecma_value_t result = ecma_op_function_call (ecma_get_object_from_value (executor), this_value, argv, 2);
    #####:  450:  ecma_deref_object (resolve_func_p);
    #####:  451:  ecma_deref_object (reject_func_p);
        -:  452:
    #####:  453:  return result;
        -:  454:} /* ecma_promise_run_executor */
        -:  455:
        -:  456:/**
        -:  457: * Create a promise object.
        -:  458: *
        -:  459: * See also: ES2015 25.4.3.1
        -:  460: *
        -:  461: * @return ecma value of the new promise object
        -:  462: *         Returned value must be freed with ecma_free_value
        -:  463: */
        -:  464:ecma_value_t
    #####:  465:ecma_op_create_promise_object (ecma_value_t executor, /**< the executor function or ECMA_VALUE_EMPTY */
        -:  466:                               ecma_value_t parent, /**< parent promise if available */
        -:  467:                               ecma_object_t *new_target_p) /**< new.target value */
        -:  468:{
        -:  469:  JERRY_UNUSED (parent);
        -:  470:
    #####:  471:  if (new_target_p == NULL)
        -:  472:  {
    #####:  473:    new_target_p = ecma_builtin_get (ECMA_BUILTIN_ID_PROMISE);
        -:  474:  }
        -:  475:
        -:  476:  /* 3. */
    #####:  477:  ecma_object_t *proto_p = ecma_op_get_prototype_from_constructor (new_target_p, ECMA_BUILTIN_ID_PROMISE_PROTOTYPE);
        -:  478:
    #####:  479:  if (JERRY_UNLIKELY (proto_p == NULL))
        -:  480:  {
    #####:  481:    return ECMA_VALUE_ERROR;
        -:  482:  }
        -:  483:
        -:  484:  /* Calling ecma_new_collection might trigger a GC call, so this
        -:  485:   * allocation is performed before the object is constructed. */
    #####:  486:  ecma_collection_t *reactions = ecma_new_collection ();
        -:  487:
    #####:  488:  ecma_object_t *object_p = ecma_create_object (proto_p, sizeof (ecma_promise_object_t), ECMA_OBJECT_TYPE_CLASS);
    #####:  489:  ecma_deref_object (proto_p);
    #####:  490:  ecma_extended_object_t *ext_object_p = (ecma_extended_object_t *) object_p;
    #####:  491:  ext_object_p->u.cls.type = ECMA_OBJECT_CLASS_PROMISE;
        -:  492:  /* 5 */
    #####:  493:  ext_object_p->u.cls.u1.promise_flags = ECMA_PROMISE_IS_PENDING;
    #####:  494:  ext_object_p->u.cls.u3.value = ECMA_VALUE_UNDEFINED;
        -:  495:
        -:  496:  /* 6-8. */
    #####:  497:  ecma_promise_object_t *promise_object_p = (ecma_promise_object_t *) object_p;
    #####:  498:  promise_object_p->reactions = reactions;
        -:  499:
        -:  500:#if JERRY_PROMISE_CALLBACK
    #####:  501:  if (JERRY_UNLIKELY (JERRY_CONTEXT (promise_callback_filters) & JERRY_PROMISE_EVENT_FILTER_CREATE))
        -:  502:  {
        -:  503:    JERRY_ASSERT (JERRY_CONTEXT (promise_callback) != NULL);
    #####:  504:    JERRY_CONTEXT (promise_callback)
        -:  505:    (JERRY_PROMISE_EVENT_CREATE, ecma_make_object_value (object_p), parent, JERRY_CONTEXT (promise_callback_user_p));
        -:  506:  }
        -:  507:#endif /* JERRY_PROMISE_CALLBACK */
        -:  508:
        -:  509:  /* 9. */
    #####:  510:  ecma_value_t completion = ECMA_VALUE_UNDEFINED;
        -:  511:
    #####:  512:  if (executor != ECMA_VALUE_EMPTY)
        -:  513:  {
    #####:  514:    JERRY_ASSERT (ecma_op_is_callable (executor));
        -:  515:
    #####:  516:    completion = ecma_promise_run_executor (object_p, executor, ECMA_VALUE_UNDEFINED);
        -:  517:  }
        -:  518:
    #####:  519:  ecma_value_t status = ECMA_VALUE_EMPTY;
        -:  520:
    #####:  521:  if (ECMA_IS_VALUE_ERROR (completion))
        -:  522:  {
        -:  523:    /* 10.a. */
    #####:  524:    completion = jcontext_take_exception ();
    #####:  525:    ecma_reject_promise_with_checks (ecma_make_object_value (object_p), completion);
        -:  526:  }
        -:  527:
    #####:  528:  ecma_free_value (completion);
        -:  529:
        -:  530:  /* 10.b. */
    #####:  531:  if (ECMA_IS_VALUE_ERROR (status))
        -:  532:  {
    #####:  533:    ecma_deref_object (object_p);
    #####:  534:    return status;
        -:  535:  }
        -:  536:
        -:  537:  /* 11. */
    #####:  538:  ecma_free_value (status);
    #####:  539:  return ecma_make_object_value (object_p);
        -:  540:} /* ecma_op_create_promise_object */
        -:  541:
        -:  542:/**
        -:  543: * Helper function for increase or decrease the remaining count.
        -:  544: *
        -:  545: * @return the current remaining count after increase or decrease.
        -:  546: */
        -:  547:uint32_t
    #####:  548:ecma_promise_remaining_inc_or_dec (ecma_value_t remaining, /**< the remaining count */
        -:  549:                                   bool is_inc) /**< whether to increase the count */
        -:  550:{
    #####:  551:  JERRY_ASSERT (ecma_is_value_object (remaining));
        -:  552:
    #####:  553:  ecma_object_t *remaining_p = ecma_get_object_from_value (remaining);
    #####:  554:  ecma_extended_object_t *ext_object_p = (ecma_extended_object_t *) remaining_p;
        -:  555:
    #####:  556:  JERRY_ASSERT (ext_object_p->u.cls.type == ECMA_OBJECT_CLASS_NUMBER);
        -:  557:
    #####:  558:  JERRY_ASSERT (ecma_is_value_integer_number (ext_object_p->u.cls.u3.value));
        -:  559:
    #####:  560:  uint32_t current = (uint32_t) ecma_get_integer_from_value (ext_object_p->u.cls.u3.value);
        -:  561:
    #####:  562:  if (is_inc)
        -:  563:  {
    #####:  564:    current++;
        -:  565:  }
        -:  566:  else
        -:  567:  {
    #####:  568:    current--;
        -:  569:  }
    #####:  570:  ext_object_p->u.cls.u3.value = ecma_make_uint32_value (current);
        -:  571:
    #####:  572:  return current;
        -:  573:} /* ecma_promise_remaining_inc_or_dec */
        -:  574:
        -:  575:/**
        -:  576: * Native handler for Promise.all and Promise.allSettled Resolve Element Function.
        -:  577: *
        -:  578: * See also:
        -:  579: *         ES2015 25.4.4.1.2
        -:  580: *
        -:  581: * @return ecma value of undefined.
        -:  582: */
        -:  583:ecma_value_t
    #####:  584:ecma_promise_all_or_all_settled_handler_cb (ecma_object_t *function_obj_p, /**< function object */
        -:  585:                                            const ecma_value_t args_p[], /**< argument list */
        -:  586:                                            const uint32_t args_count) /**< argument number */
        -:  587:{
        -:  588:  JERRY_UNUSED (args_count);
    #####:  589:  ecma_promise_all_executor_t *executor_p = (ecma_promise_all_executor_t *) function_obj_p;
    #####:  590:  uint8_t promise_type = executor_p->header.u.built_in.u2.routine_flags;
        -:  591:
    #####:  592:  promise_type = (uint8_t) (promise_type >> ECMA_NATIVE_HANDLER_COMMON_FLAGS_SHIFT);
        -:  593:
        -:  594:  /* 1 - 2. */
    #####:  595:  if (executor_p->index == 0)
        -:  596:  {
    #####:  597:    return ECMA_VALUE_UNDEFINED;
        -:  598:  }
        -:  599:
    #####:  600:  if (promise_type == ECMA_PROMISE_ALL_RESOLVE || promise_type == ECMA_PROMISE_ANY_REJECT)
        -:  601:  {
        -:  602:    /* 8. */
    #####:  603:    ecma_op_object_put_by_index (ecma_get_object_from_value (executor_p->values),
    #####:  604:                                 (uint32_t) (executor_p->index - 1),
        -:  605:                                 args_p[0],
        -:  606:                                 false);
        -:  607:  }
        -:  608:  else
        -:  609:  {
    #####:  610:    lit_magic_string_id_t status_property_val = LIT_MAGIC_STRING_REJECTED;
    #####:  611:    lit_magic_string_id_t data_propery_name = LIT_MAGIC_STRING_REASON;
        -:  612:
    #####:  613:    if (promise_type == ECMA_PROMISE_ALLSETTLED_RESOLVE)
        -:  614:    {
    #####:  615:      status_property_val = LIT_MAGIC_STRING_FULFILLED;
    #####:  616:      data_propery_name = LIT_MAGIC_STRING_VALUE;
        -:  617:    }
        -:  618:
    #####:  619:    ecma_object_t *obj_p =
    #####:  620:      ecma_create_object (ecma_builtin_get (ECMA_BUILTIN_ID_OBJECT_PROTOTYPE), 0, ECMA_OBJECT_TYPE_GENERAL);
        -:  621:    ecma_property_value_t *prop_value_p;
    #####:  622:    prop_value_p = ecma_create_named_data_property (obj_p,
        -:  623:                                                    ecma_get_magic_string (LIT_MAGIC_STRING_STATUS),
        -:  624:                                                    ECMA_PROPERTY_CONFIGURABLE_ENUMERABLE_WRITABLE,
        -:  625:                                                    NULL);
        -:  626:
    #####:  627:    prop_value_p->value = ecma_make_magic_string_value (status_property_val);
        -:  628:
    #####:  629:    prop_value_p = ecma_create_named_data_property (obj_p,
        -:  630:                                                    ecma_get_magic_string (data_propery_name),
        -:  631:                                                    ECMA_PROPERTY_CONFIGURABLE_ENUMERABLE_WRITABLE,
        -:  632:                                                    NULL);
    #####:  633:    prop_value_p->value = ECMA_VALUE_UNDEFINED;
        -:  634:
    #####:  635:    if (args_count != 0)
        -:  636:    {
    #####:  637:      prop_value_p->value = ecma_copy_value_if_not_object (args_p[0]);
        -:  638:    }
        -:  639:
    #####:  640:    ecma_value_t obj_val = ecma_make_object_value (obj_p);
        -:  641:    /* 12. */
    #####:  642:    ecma_op_object_put_by_index (ecma_get_object_from_value (executor_p->values),
    #####:  643:                                 (uint32_t) (executor_p->index - 1),
        -:  644:                                 obj_val,
        -:  645:                                 false);
    #####:  646:    ecma_deref_object (obj_p);
        -:  647:  }
        -:  648:  /* 3. */
    #####:  649:  executor_p->index = 0;
        -:  650:
        -:  651:  /* 9-10. */
    #####:  652:  ecma_value_t ret = ECMA_VALUE_UNDEFINED;
    #####:  653:  if (ecma_promise_remaining_inc_or_dec (executor_p->remaining_elements, false) == 0)
        -:  654:  {
    #####:  655:    ecma_value_t capability = executor_p->capability;
    #####:  656:    ecma_promise_capabality_t *capability_p = (ecma_promise_capabality_t *) ecma_get_object_from_value (capability);
    #####:  657:    if (promise_type == ECMA_PROMISE_ANY_REJECT)
        -:  658:    {
    #####:  659:      ecma_value_t error_val = ecma_new_aggregate_error (executor_p->values, ECMA_VALUE_UNDEFINED);
    #####:  660:      ret =
    #####:  661:        ecma_op_function_call (ecma_get_object_from_value (capability_p->reject), ECMA_VALUE_UNDEFINED, &error_val, 1);
    #####:  662:      ecma_free_value (error_val);
        -:  663:    }
        -:  664:    else
        -:  665:    {
    #####:  666:      ret = ecma_op_function_call (ecma_get_object_from_value (capability_p->resolve),
        -:  667:                                   ECMA_VALUE_UNDEFINED,
    #####:  668:                                   &executor_p->values,
        -:  669:                                   1);
        -:  670:    }
        -:  671:  }
        -:  672:
    #####:  673:  return ret;
        -:  674:} /* ecma_promise_all_or_all_settled_handler_cb */
        -:  675:
        -:  676:/**
        -:  677: * GetCapabilitiesExecutor Functions
        -:  678: *
        -:  679: * Checks and sets a promiseCapability's resolve and reject properties.
        -:  680: *
        -:  681: * See also: ES11 25.6.1.5.1
        -:  682: *
        -:  683: * @return ECMA_VALUE_UNDEFINED or TypeError
        -:  684: *         returned value must be freed with ecma_free_value
        -:  685: */
        -:  686:ecma_value_t
    #####:  687:ecma_op_get_capabilities_executor_cb (ecma_object_t *function_obj_p, /**< function object */
        -:  688:                                      const ecma_value_t args_p[], /**< argument list */
        -:  689:                                      const uint32_t args_count) /**< argument number */
        -:  690:{
        -:  691:  /* 1. */
    #####:  692:  ecma_promise_capability_executor_t *executor_p = (ecma_promise_capability_executor_t *) function_obj_p;
        -:  693:
        -:  694:  /* 2-3. */
    #####:  695:  ecma_object_t *capability_obj_p = ecma_get_object_from_value (executor_p->capability);
    #####:  696:  JERRY_ASSERT (ecma_object_class_is (capability_obj_p, ECMA_OBJECT_CLASS_PROMISE_CAPABILITY));
    #####:  697:  ecma_promise_capabality_t *capability_p = (ecma_promise_capabality_t *) capability_obj_p;
        -:  698:
        -:  699:  /* 4. */
    #####:  700:  if (!ecma_is_value_undefined (capability_p->resolve))
        -:  701:  {
    #####:  702:    return ecma_raise_type_error (ECMA_ERR_RESOLVE_MUST_BE_UNDEFINED);
        -:  703:  }
        -:  704:
        -:  705:  /* 5. */
    #####:  706:  if (!ecma_is_value_undefined (capability_p->reject))
        -:  707:  {
    #####:  708:    return ecma_raise_type_error (ECMA_ERR_REJECT_MUST_BE_UNDEFINED);
        -:  709:  }
        -:  710:
        -:  711:  /* 6. */
    #####:  712:  capability_p->resolve = (args_count > 0) ? args_p[0] : ECMA_VALUE_UNDEFINED;
        -:  713:  /* 7. */
    #####:  714:  capability_p->reject = (args_count > 1) ? args_p[1] : ECMA_VALUE_UNDEFINED;
        -:  715:
        -:  716:  /* 8. */
    #####:  717:  return ECMA_VALUE_UNDEFINED;
        -:  718:} /* ecma_op_get_capabilities_executor_cb */
        -:  719:
        -:  720:/**
        -:  721: * Create a new PromiseCapability.
        -:  722: *
        -:  723: * See also: ES11 25.6.1.5
        -:  724: *
        -:  725: * @return NULL - if the operation raises error
        -:  726: *         new PromiseCapability object - otherwise
        -:  727: */
        -:  728:ecma_object_t *
    #####:  729:ecma_promise_new_capability (ecma_value_t constructor, /**< constructor function */
        -:  730:                             ecma_value_t parent) /**< parent promise if available */
        -:  731:{
        -:  732:  /* 1. */
    #####:  733:  if (!ecma_is_constructor (constructor))
        -:  734:  {
    #####:  735:    ecma_raise_type_error (ECMA_ERR_INVALID_CAPABILITY);
    #####:  736:    return NULL;
        -:  737:  }
        -:  738:
    #####:  739:  ecma_object_t *constructor_obj_p = ecma_get_object_from_value (constructor);
        -:  740:
        -:  741:  /* 3. */
    #####:  742:  ecma_object_t *capability_obj_p = ecma_create_object (ecma_builtin_get (ECMA_BUILTIN_ID_OBJECT_PROTOTYPE),
        -:  743:                                                        sizeof (ecma_promise_capabality_t),
        -:  744:                                                        ECMA_OBJECT_TYPE_CLASS);
        -:  745:
    #####:  746:  ecma_promise_capabality_t *capability_p = (ecma_promise_capabality_t *) capability_obj_p;
    #####:  747:  capability_p->header.u.cls.type = ECMA_OBJECT_CLASS_PROMISE_CAPABILITY;
    #####:  748:  capability_p->header.u.cls.u3.promise = ECMA_VALUE_UNDEFINED;
    #####:  749:  capability_p->resolve = ECMA_VALUE_UNDEFINED;
    #####:  750:  capability_p->reject = ECMA_VALUE_UNDEFINED;
        -:  751:
        -:  752:  /* 4-5. */
    #####:  753:  ecma_object_t *executor_p = ecma_op_create_native_handler (ECMA_NATIVE_HANDLER_PROMISE_CAPABILITY_EXECUTOR,
        -:  754:                                                             sizeof (ecma_promise_capability_executor_t));
        -:  755:
        -:  756:  /* 6. */
    #####:  757:  ecma_promise_capability_executor_t *executor_func_p = (ecma_promise_capability_executor_t *) executor_p;
    #####:  758:  executor_func_p->capability = ecma_make_object_value (capability_obj_p);
        -:  759:
        -:  760:  /* 7. */
    #####:  761:  ecma_value_t executor = ecma_make_object_value (executor_p);
        -:  762:  ecma_value_t promise;
        -:  763:
    #####:  764:  if (constructor_obj_p == ecma_builtin_get (ECMA_BUILTIN_ID_PROMISE))
        -:  765:  {
    #####:  766:    promise = ecma_op_create_promise_object (executor, parent, constructor_obj_p);
        -:  767:  }
        -:  768:  else
        -:  769:  {
    #####:  770:    promise = ecma_op_function_construct (constructor_obj_p, constructor_obj_p, &executor, 1);
        -:  771:  }
        -:  772:
    #####:  773:  ecma_deref_object (executor_p);
        -:  774:
    #####:  775:  if (ECMA_IS_VALUE_ERROR (promise))
        -:  776:  {
    #####:  777:    ecma_deref_object (capability_obj_p);
    #####:  778:    return NULL;
        -:  779:  }
        -:  780:
        -:  781:  /* 8. */
    #####:  782:  if (!ecma_op_is_callable (capability_p->resolve))
        -:  783:  {
    #####:  784:    ecma_free_value (promise);
    #####:  785:    ecma_deref_object (capability_obj_p);
    #####:  786:    ecma_raise_type_error (ECMA_ERR_PARAMETER_RESOLVE_MUST_BE_CALLABLE);
    #####:  787:    return NULL;
        -:  788:  }
        -:  789:
        -:  790:  /* 9. */
    #####:  791:  if (!ecma_op_is_callable (capability_p->reject))
        -:  792:  {
    #####:  793:    ecma_free_value (promise);
    #####:  794:    ecma_deref_object (capability_obj_p);
    #####:  795:    ecma_raise_type_error (ECMA_ERR_PARAMETER_REJECT_MUST_BE_CALLABLE);
    #####:  796:    return NULL;
        -:  797:  }
        -:  798:
        -:  799:  /* 10. */
    #####:  800:  capability_p->header.u.cls.u3.promise = promise;
        -:  801:
    #####:  802:  ecma_free_value (promise);
        -:  803:
        -:  804:  /* 11. */
    #####:  805:  return capability_obj_p;
        -:  806:} /* ecma_promise_new_capability */
        -:  807:
        -:  808:/**
        -:  809: * The common function for 'reject' and 'resolve'.
        -:  810: *
        -:  811: * @return ecma value
        -:  812: *         Returned value must be freed with ecma_free_value.
        -:  813: */
        -:  814:ecma_value_t
    #####:  815:ecma_promise_reject_or_resolve (ecma_value_t this_arg, /**< "this" argument */
        -:  816:                                ecma_value_t value, /**< rejected or resolved value */
        -:  817:                                bool is_resolve) /**< the operation is resolve */
        -:  818:{
    #####:  819:  if (!ecma_is_value_object (this_arg))
        -:  820:  {
    #####:  821:    return ecma_raise_type_error (ECMA_ERR_ARGUMENT_THIS_NOT_OBJECT);
        -:  822:  }
        -:  823:
    #####:  824:  if (is_resolve && ecma_is_value_object (value) && ecma_is_promise (ecma_get_object_from_value (value)))
        -:  825:  {
    #####:  826:    ecma_object_t *object_p = ecma_get_object_from_value (value);
    #####:  827:    ecma_value_t constructor = ecma_op_object_get_by_magic_id (object_p, LIT_MAGIC_STRING_CONSTRUCTOR);
        -:  828:
    #####:  829:    if (ECMA_IS_VALUE_ERROR (constructor))
        -:  830:    {
    #####:  831:      return constructor;
        -:  832:    }
        -:  833:
        -:  834:    /* The this_arg must be an object. */
    #####:  835:    bool is_same_value = (constructor == this_arg);
    #####:  836:    ecma_free_value (constructor);
        -:  837:
    #####:  838:    if (is_same_value)
        -:  839:    {
    #####:  840:      return ecma_copy_value (value);
        -:  841:    }
        -:  842:  }
        -:  843:
    #####:  844:  ecma_object_t *capability_obj_p = ecma_promise_new_capability (this_arg, ECMA_VALUE_UNDEFINED);
        -:  845:
    #####:  846:  if (JERRY_UNLIKELY (capability_obj_p == NULL))
        -:  847:  {
    #####:  848:    return ECMA_VALUE_ERROR;
        -:  849:  }
        -:  850:
    #####:  851:  ecma_promise_capabality_t *capability_p = (ecma_promise_capabality_t *) capability_obj_p;
        -:  852:
    #####:  853:  ecma_value_t func = is_resolve ? capability_p->resolve : capability_p->reject;
        -:  854:
    #####:  855:  ecma_value_t call_ret = ecma_op_function_call (ecma_get_object_from_value (func), ECMA_VALUE_UNDEFINED, &value, 1);
        -:  856:
    #####:  857:  if (ECMA_IS_VALUE_ERROR (call_ret))
        -:  858:  {
    #####:  859:    ecma_deref_object (capability_obj_p);
    #####:  860:    return call_ret;
        -:  861:  }
        -:  862:
    #####:  863:  ecma_free_value (call_ret);
        -:  864:
    #####:  865:  ecma_value_t promise = ecma_copy_value (capability_p->header.u.cls.u3.promise);
    #####:  866:  ecma_deref_object (capability_obj_p);
        -:  867:
    #####:  868:  return promise;
        -:  869:} /* ecma_promise_reject_or_resolve */
        -:  870:
        -:  871:/**
        -:  872: * The common function for ecma_builtin_promise_prototype_then
        -:  873: * and ecma_builtin_promise_prototype_catch.
        -:  874: *
        -:  875: * @return ecma value of a new promise object.
        -:  876: *         Returned value must be freed with ecma_free_value.
        -:  877: */
        -:  878:ecma_value_t
    #####:  879:ecma_promise_then (ecma_value_t promise, /**< the promise which call 'then' */
        -:  880:                   ecma_value_t on_fulfilled, /**< on_fulfilled function */
        -:  881:                   ecma_value_t on_rejected) /**< on_rejected function */
        -:  882:{
    #####:  883:  if (!ecma_is_value_object (promise))
        -:  884:  {
    #####:  885:    return ecma_raise_type_error (ECMA_ERR_ARGUMENT_THIS_NOT_OBJECT);
        -:  886:  }
        -:  887:
    #####:  888:  ecma_object_t *obj = ecma_get_object_from_value (promise);
        -:  889:
    #####:  890:  if (!ecma_is_promise (obj))
        -:  891:  {
    #####:  892:    return ecma_raise_type_error (ECMA_ERR_ARGUMENT_THIS_NOT_PROMISE);
        -:  893:  }
        -:  894:
    #####:  895:  ecma_value_t species = ecma_op_species_constructor (obj, ECMA_BUILTIN_ID_PROMISE);
    #####:  896:  if (ECMA_IS_VALUE_ERROR (species))
        -:  897:  {
    #####:  898:    return species;
        -:  899:  }
        -:  900:
    #####:  901:  ecma_object_t *result_capability_obj_p = ecma_promise_new_capability (species, promise);
    #####:  902:  ecma_free_value (species);
        -:  903:
    #####:  904:  if (JERRY_UNLIKELY (result_capability_obj_p == NULL))
        -:  905:  {
    #####:  906:    return ECMA_VALUE_ERROR;
        -:  907:  }
        -:  908:
    #####:  909:  ecma_value_t ret = ecma_promise_perform_then (promise, on_fulfilled, on_rejected, result_capability_obj_p);
    #####:  910:  ecma_deref_object (result_capability_obj_p);
        -:  911:
    #####:  912:  return ret;
        -:  913:} /* ecma_promise_then */
        -:  914:
        -:  915:/**
        -:  916: * Definition of valueThunk function
        -:  917: *
        -:  918: * See also:
        -:  919: *         ES2020 25.6.5.3.1 step 8.
        -:  920: *
        -:  921: * @return ecma value
        -:  922: */
        -:  923:ecma_value_t
    #####:  924:ecma_value_thunk_helper_cb (ecma_object_t *function_obj_p, /**< function object */
        -:  925:                            const ecma_value_t args_p[], /**< argument list */
        -:  926:                            const uint32_t args_count) /**< argument number */
        -:  927:{
        -:  928:  JERRY_UNUSED_2 (args_p, args_count);
        -:  929:
    #####:  930:  ecma_promise_value_thunk_t *value_thunk_obj_p = (ecma_promise_value_thunk_t *) function_obj_p;
        -:  931:
    #####:  932:  return ecma_copy_value (value_thunk_obj_p->value);
        -:  933:} /* ecma_value_thunk_helper_cb */
        -:  934:
        -:  935:/**
        -:  936: * Definition of thrower function
        -:  937: *
        -:  938: * See also:
        -:  939: *         ES2020 25.6.5.3.2 step 8.
        -:  940: *
        -:  941: * @return ecma value
        -:  942: */
        -:  943:ecma_value_t
    #####:  944:ecma_value_thunk_thrower_cb (ecma_object_t *function_obj_p, /**< function object */
        -:  945:                             const ecma_value_t args_p[], /**< argument list */
        -:  946:                             const uint32_t args_count) /**< argument number */
        -:  947:{
        -:  948:  JERRY_UNUSED_2 (args_p, args_count);
        -:  949:
    #####:  950:  ecma_promise_value_thunk_t *value_thunk_obj_p = (ecma_promise_value_thunk_t *) function_obj_p;
        -:  951:
    #####:  952:  jcontext_raise_exception (ecma_copy_value (value_thunk_obj_p->value));
        -:  953:
    #####:  954:  return ECMA_VALUE_ERROR;
        -:  955:} /* ecma_value_thunk_thrower_cb */
        -:  956:
        -:  957:/**
        -:  958: * Helper function for Then Finally and Catch Finally common parts
        -:  959: *
        -:  960: * See also:
        -:  961: *         ES2020 25.6.5.3.1
        -:  962: *         ES2020 25.6.5.3.2
        -:  963: *
        -:  964: * @return ecma value
        -:  965: */
        -:  966:static ecma_value_t
    #####:  967:ecma_promise_then_catch_finally_helper (ecma_object_t *function_obj_p, /**< function object */
        -:  968:                                        ecma_native_handler_id_t id, /**< handler id */
        -:  969:                                        ecma_value_t arg) /**< callback function argument */
        -:  970:{
        -:  971:  /* 2. */
    #####:  972:  ecma_promise_finally_function_t *finally_func_obj = (ecma_promise_finally_function_t *) function_obj_p;
        -:  973:
        -:  974:  /* 3. */
    #####:  975:  JERRY_ASSERT (ecma_op_is_callable (finally_func_obj->on_finally));
        -:  976:
        -:  977:  /* 4. */
    #####:  978:  ecma_value_t result =
    #####:  979:    ecma_op_function_call (ecma_get_object_from_value (finally_func_obj->on_finally), ECMA_VALUE_UNDEFINED, NULL, 0);
        -:  980:
    #####:  981:  if (ECMA_IS_VALUE_ERROR (result))
        -:  982:  {
    #####:  983:    return result;
        -:  984:  }
        -:  985:
        -:  986:  /* 6. */
    #####:  987:  JERRY_ASSERT (ecma_is_constructor (finally_func_obj->constructor));
        -:  988:
        -:  989:  /* 7. */
    #####:  990:  ecma_value_t promise = ecma_promise_reject_or_resolve (finally_func_obj->constructor, result, true);
        -:  991:
    #####:  992:  ecma_free_value (result);
        -:  993:
    #####:  994:  if (ECMA_IS_VALUE_ERROR (promise))
        -:  995:  {
    #####:  996:    return promise;
        -:  997:  }
        -:  998:
        -:  999:  /* 8. */
        -: 1000:  ecma_object_t *value_thunk_func_p;
    #####: 1001:  value_thunk_func_p = ecma_op_create_native_handler (id, sizeof (ecma_promise_value_thunk_t));
        -: 1002:
    #####: 1003:  ecma_promise_value_thunk_t *value_thunk_func_obj = (ecma_promise_value_thunk_t *) value_thunk_func_p;
    #####: 1004:  value_thunk_func_obj->value = ecma_copy_value_if_not_object (arg);
        -: 1005:
        -: 1006:  /* 9. */
    #####: 1007:  ecma_value_t value_thunk = ecma_make_object_value (value_thunk_func_p);
    #####: 1008:  ecma_value_t ret_value = ecma_op_invoke_by_magic_id (promise, LIT_MAGIC_STRING_THEN, &value_thunk, 1);
        -: 1009:
    #####: 1010:  ecma_free_value (promise);
    #####: 1011:  ecma_deref_object (value_thunk_func_p);
        -: 1012:
    #####: 1013:  return ret_value;
        -: 1014:} /* ecma_promise_then_catch_finally_helper */
        -: 1015:
        -: 1016:/**
        -: 1017: * Definition of Then Finally Function
        -: 1018: *
        -: 1019: * See also:
        -: 1020: *         ES2020 25.6.5.3.1
        -: 1021: *
        -: 1022: * @return ecma value
        -: 1023: */
        -: 1024:ecma_value_t
    #####: 1025:ecma_promise_then_finally_cb (ecma_object_t *function_obj_p, /**< function object */
        -: 1026:                              const ecma_value_t args_p[], /**< argument list */
        -: 1027:                              const uint32_t args_count) /**< argument number */
        -: 1028:{
        -: 1029:  JERRY_UNUSED (args_count);
    #####: 1030:  JERRY_ASSERT (args_count > 0);
        -: 1031:
    #####: 1032:  return ecma_promise_then_catch_finally_helper (function_obj_p, ECMA_NATIVE_HANDLER_VALUE_THUNK, args_p[0]);
        -: 1033:} /* ecma_promise_then_finally_cb */
        -: 1034:
        -: 1035:/**
        -: 1036: * Definition of Catch Finally Function
        -: 1037: *
        -: 1038: * See also:
        -: 1039: *         ES2020 25.6.5.3.2
        -: 1040: *
        -: 1041: * @return ecma value
        -: 1042: */
        -: 1043:ecma_value_t
    #####: 1044:ecma_promise_catch_finally_cb (ecma_object_t *function_obj_p, /**< function object */
        -: 1045:                               const ecma_value_t args_p[], /**< argument list */
        -: 1046:                               const uint32_t args_count) /**< argument number */
        -: 1047:{
        -: 1048:  JERRY_UNUSED (args_count);
    #####: 1049:  JERRY_ASSERT (args_count > 0);
        -: 1050:
    #####: 1051:  return ecma_promise_then_catch_finally_helper (function_obj_p, ECMA_NATIVE_HANDLER_VALUE_THROWER, args_p[0]);
        -: 1052:} /* ecma_promise_catch_finally_cb */
        -: 1053:
        -: 1054:/**
        -: 1055: * The common function for ecma_builtin_promise_prototype_finally
        -: 1056: *
        -: 1057: * @return ecma value of a new promise object.
        -: 1058: *         Returned value must be freed with ecma_free_value.
        -: 1059: */
        -: 1060:ecma_value_t
    #####: 1061:ecma_promise_finally (ecma_value_t promise, /**< the promise which call 'finally' */
        -: 1062:                      ecma_value_t on_finally) /**< on_finally function */
        -: 1063:{
        -: 1064:  /* 2. */
    #####: 1065:  if (!ecma_is_value_object (promise))
        -: 1066:  {
    #####: 1067:    return ecma_raise_type_error (ECMA_ERR_ARGUMENT_THIS_NOT_OBJECT);
        -: 1068:  }
        -: 1069:
    #####: 1070:  ecma_object_t *obj = ecma_get_object_from_value (promise);
        -: 1071:
        -: 1072:  /* 3. */
    #####: 1073:  ecma_value_t species = ecma_op_species_constructor (obj, ECMA_BUILTIN_ID_PROMISE);
        -: 1074:
    #####: 1075:  if (ECMA_IS_VALUE_ERROR (species))
        -: 1076:  {
    #####: 1077:    return species;
        -: 1078:  }
        -: 1079:
        -: 1080:  /* 4. */
    #####: 1081:  JERRY_ASSERT (ecma_is_constructor (species));
        -: 1082:
        -: 1083:  /* 5. */
    #####: 1084:  if (!ecma_op_is_callable (on_finally))
        -: 1085:  {
    #####: 1086:    ecma_free_value (species);
    #####: 1087:    ecma_value_t invoke_args[2] = { on_finally, on_finally };
    #####: 1088:    return ecma_op_invoke_by_magic_id (promise, LIT_MAGIC_STRING_THEN, invoke_args, 2);
        -: 1089:  }
        -: 1090:
        -: 1091:  /* 6.a-b */
        -: 1092:  ecma_object_t *then_finally_obj_p;
    #####: 1093:  then_finally_obj_p =
        -: 1094:    ecma_op_create_native_handler (ECMA_NATIVE_HANDLER_PROMISE_THEN_FINALLY, sizeof (ecma_promise_finally_function_t));
        -: 1095:
        -: 1096:  /* 6.c-d */
    #####: 1097:  ecma_promise_finally_function_t *then_finally_func_obj_p = (ecma_promise_finally_function_t *) then_finally_obj_p;
    #####: 1098:  then_finally_func_obj_p->constructor = species;
    #####: 1099:  then_finally_func_obj_p->on_finally = on_finally;
        -: 1100:
        -: 1101:  /* 6.e-f */
        -: 1102:  ecma_object_t *catch_finally_obj_p;
    #####: 1103:  catch_finally_obj_p =
        -: 1104:    ecma_op_create_native_handler (ECMA_NATIVE_HANDLER_PROMISE_CATCH_FINALLY, sizeof (ecma_promise_finally_function_t));
        -: 1105:
        -: 1106:  /* 6.g-h */
    #####: 1107:  ecma_promise_finally_function_t *catch_finally_func_obj = (ecma_promise_finally_function_t *) catch_finally_obj_p;
    #####: 1108:  catch_finally_func_obj->constructor = species;
    #####: 1109:  catch_finally_func_obj->on_finally = on_finally;
        -: 1110:
    #####: 1111:  ecma_deref_object (ecma_get_object_from_value (species));
        -: 1112:
        -: 1113:  /* 7. */
    #####: 1114:  ecma_value_t invoke_args[2] = { ecma_make_object_value (then_finally_obj_p),
    #####: 1115:                                  ecma_make_object_value (catch_finally_obj_p) };
        -: 1116:
    #####: 1117:  ecma_value_t ret_value = ecma_op_invoke_by_magic_id (promise, LIT_MAGIC_STRING_THEN, invoke_args, 2);
        -: 1118:
    #####: 1119:  ecma_deref_object (then_finally_obj_p);
    #####: 1120:  ecma_deref_object (catch_finally_obj_p);
        -: 1121:
    #####: 1122:  return ret_value;
        -: 1123:} /* ecma_promise_finally */
        -: 1124:
        -: 1125:/**
        -: 1126: * Resume the execution of an async function after the promise is resolved
        -: 1127: */
        -: 1128:void
    #####: 1129:ecma_promise_async_then (ecma_value_t promise, /**< promise object */
        -: 1130:                         ecma_value_t executable_object) /**< executable object of the async function */
        -: 1131:{
        -: 1132:#if JERRY_PROMISE_CALLBACK
    #####: 1133:  if (JERRY_UNLIKELY (JERRY_CONTEXT (promise_callback_filters) & JERRY_PROMISE_EVENT_FILTER_ASYNC_MAIN))
        -: 1134:  {
        -: 1135:    JERRY_ASSERT (JERRY_CONTEXT (promise_callback) != NULL);
    #####: 1136:    JERRY_CONTEXT (promise_callback)
        -: 1137:    (JERRY_PROMISE_EVENT_ASYNC_AWAIT, executable_object, promise, JERRY_CONTEXT (promise_callback_user_p));
        -: 1138:  }
        -: 1139:#endif /* JERRY_PROMISE_CALLBACK */
        -: 1140:
    #####: 1141:  ecma_object_t *promise_obj_p = ecma_get_object_from_value (promise);
    #####: 1142:  uint16_t flags = ecma_promise_get_flags (promise_obj_p);
        -: 1143:
    #####: 1144:  if (flags & ECMA_PROMISE_IS_PENDING)
        -: 1145:  {
        -: 1146:    ecma_value_t executable_object_with_tag;
    #####: 1147:    ECMA_SET_NON_NULL_POINTER_TAG (executable_object_with_tag, ecma_get_object_from_value (executable_object), 0);
    #####: 1148:    ECMA_SET_THIRD_BIT_TO_POINTER_TAG (executable_object_with_tag);
        -: 1149:
    #####: 1150:    ecma_collection_push_back (((ecma_promise_object_t *) promise_obj_p)->reactions, executable_object_with_tag);
    #####: 1151:    return;
        -: 1152:  }
        -: 1153:
    #####: 1154:  ecma_value_t value = ecma_promise_get_result (promise_obj_p);
    #####: 1155:  ecma_enqueue_promise_async_reaction_job (executable_object, value, !(flags & ECMA_PROMISE_IS_FULFILLED));
    #####: 1156:  ecma_free_value (value);
        -: 1157:
        -: 1158:#if JERRY_PROMISE_CALLBACK
    #####: 1159:  if (ecma_promise_get_flags (promise_obj_p) & ECMA_PROMISE_UNHANDLED_REJECT)
        -: 1160:  {
    #####: 1161:    ((ecma_extended_object_t *) promise_obj_p)->u.cls.u1.promise_flags &= (uint8_t) ~ECMA_PROMISE_UNHANDLED_REJECT;
        -: 1162:
    #####: 1163:    if (JERRY_UNLIKELY (JERRY_CONTEXT (promise_callback_filters) & JERRY_PROMISE_EVENT_FILTER_ERROR))
        -: 1164:    {
        -: 1165:      JERRY_ASSERT (JERRY_CONTEXT (promise_callback) != NULL);
    #####: 1166:      JERRY_CONTEXT (promise_callback)
        -: 1167:      (JERRY_PROMISE_EVENT_CATCH_HANDLER_ADDED, promise, ECMA_VALUE_UNDEFINED, JERRY_CONTEXT (promise_callback_user_p));
        -: 1168:    }
        -: 1169:  }
        -: 1170:#endif /* JERRY_PROMISE_CALLBACK */
        -: 1171:} /* ecma_promise_async_then */
        -: 1172:
        -: 1173:/**
        -: 1174: * Resolves the value and resume the execution of an async function after the resolve is completed
        -: 1175: *
        -: 1176: * @return ECMA_VALUE_UNDEFINED if not error is occurred, an error otherwise
        -: 1177: */
        -: 1178:ecma_value_t
    #####: 1179:ecma_promise_async_await (ecma_extended_object_t *async_generator_object_p, /**< async generator function */
        -: 1180:                          ecma_value_t value) /**< value to be resolved (takes the reference) */
        -: 1181:{
    #####: 1182:  ecma_value_t promise = ecma_make_object_value (ecma_builtin_get (ECMA_BUILTIN_ID_PROMISE));
    #####: 1183:  ecma_value_t result = ecma_promise_reject_or_resolve (promise, value, true);
        -: 1184:
    #####: 1185:  ecma_free_value (value);
        -: 1186:
    #####: 1187:  if (ECMA_IS_VALUE_ERROR (result))
        -: 1188:  {
    #####: 1189:    return result;
        -: 1190:  }
        -: 1191:
    #####: 1192:  ecma_promise_async_then (result, ecma_make_object_value ((ecma_object_t *) async_generator_object_p));
    #####: 1193:  ecma_free_value (result);
    #####: 1194:  return ECMA_VALUE_UNDEFINED;
        -: 1195:} /* ecma_promise_async_await */
        -: 1196:
        -: 1197:/**
        -: 1198: * Reject the promise if the value is error.
        -: 1199: *
        -: 1200: * See also:
        -: 1201: *         ES2015 25.4.1.1.1
        -: 1202: *
        -: 1203: * @return ecma value of the new promise.
        -: 1204: *         Returned value must be freed with ecma_free_value.
        -: 1205: */
        -: 1206:ecma_value_t
    #####: 1207:ecma_op_if_abrupt_reject_promise (ecma_value_t *value_p, /**< [in - out] completion value */
        -: 1208:                                  ecma_object_t *capability_obj_p) /**< capability */
        -: 1209:{
    #####: 1210:  JERRY_ASSERT (ecma_object_class_is (capability_obj_p, ECMA_OBJECT_CLASS_PROMISE_CAPABILITY));
        -: 1211:
    #####: 1212:  if (!ECMA_IS_VALUE_ERROR (*value_p))
        -: 1213:  {
    #####: 1214:    return ECMA_VALUE_EMPTY;
        -: 1215:  }
        -: 1216:
    #####: 1217:  ecma_value_t reason = jcontext_take_exception ();
        -: 1218:
    #####: 1219:  ecma_promise_capabality_t *capability_p = (ecma_promise_capabality_t *) capability_obj_p;
    #####: 1220:  ecma_value_t call_ret =
    #####: 1221:    ecma_op_function_call (ecma_get_object_from_value (capability_p->reject), ECMA_VALUE_UNDEFINED, &reason, 1);
    #####: 1222:  ecma_free_value (reason);
        -: 1223:
    #####: 1224:  if (ECMA_IS_VALUE_ERROR (call_ret))
        -: 1225:  {
    #####: 1226:    *value_p = call_ret;
    #####: 1227:    return call_ret;
        -: 1228:  }
        -: 1229:
    #####: 1230:  ecma_free_value (call_ret);
    #####: 1231:  *value_p = ecma_copy_value (capability_p->header.u.cls.u3.promise);
        -: 1232:
    #####: 1233:  return ECMA_VALUE_EMPTY;
        -: 1234:} /* ecma_op_if_abrupt_reject_promise */
        -: 1235:
        -: 1236:/**
        -: 1237: * It performs the "then" operation on promiFulfilled
        -: 1238: * and onRejected as its settlement actions.
        -: 1239: *
        -: 1240: * See also: 25.4.5.3.1
        -: 1241: *
        -: 1242: * @return ecma value of the new promise object
        -: 1243: *         Returned value must be freed with ecma_free_value
        -: 1244: */
        -: 1245:ecma_value_t
    #####: 1246:ecma_promise_perform_then (ecma_value_t promise, /**< the promise which call 'then' */
        -: 1247:                           ecma_value_t on_fulfilled, /**< on_fulfilled function */
        -: 1248:                           ecma_value_t on_rejected, /**< on_rejected function */
        -: 1249:                           ecma_object_t *result_capability_obj_p) /**< promise capability */
        -: 1250:{
    #####: 1251:  JERRY_ASSERT (ecma_object_class_is (result_capability_obj_p, ECMA_OBJECT_CLASS_PROMISE_CAPABILITY));
        -: 1252:
    #####: 1253:  ecma_promise_capabality_t *capability_p = (ecma_promise_capabality_t *) result_capability_obj_p;
        -: 1254:
        -: 1255:  /* 3. boolean true indicates "indentity" */
    #####: 1256:  if (!ecma_op_is_callable (on_fulfilled))
        -: 1257:  {
    #####: 1258:    on_fulfilled = ECMA_VALUE_TRUE;
        -: 1259:  }
        -: 1260:
        -: 1261:  /* 4. boolean false indicates "thrower" */
    #####: 1262:  if (!ecma_op_is_callable (on_rejected))
        -: 1263:  {
    #####: 1264:    on_rejected = ECMA_VALUE_FALSE;
        -: 1265:  }
        -: 1266:
    #####: 1267:  ecma_object_t *promise_obj_p = ecma_get_object_from_value (promise);
    #####: 1268:  ecma_promise_object_t *promise_p = (ecma_promise_object_t *) promise_obj_p;
        -: 1269:
    #####: 1270:  uint16_t flags = ecma_promise_get_flags (promise_obj_p);
        -: 1271:
    #####: 1272:  if (flags & ECMA_PROMISE_IS_PENDING)
        -: 1273:  {
        -: 1274:    /* 7. */
        -: 1275:    /* [ capability, (on_fulfilled), (on_rejected) ] */
    #####: 1276:    ecma_value_t reaction_values[3];
    #####: 1277:    ecma_value_t *reactions_p = reaction_values + 1;
        -: 1278:
    #####: 1279:    uint8_t tag = 0;
        -: 1280:
    #####: 1281:    if (on_fulfilled != ECMA_VALUE_TRUE)
        -: 1282:    {
    #####: 1283:      tag |= JMEM_FIRST_TAG_BIT_MASK;
    #####: 1284:      *reactions_p++ = on_fulfilled;
        -: 1285:    }
        -: 1286:
    #####: 1287:    if (on_rejected != ECMA_VALUE_FALSE)
        -: 1288:    {
    #####: 1289:      tag |= JMEM_SECOND_TAG_BIT_MASK;
    #####: 1290:      *reactions_p++ = on_rejected;
        -: 1291:    }
        -: 1292:
    #####: 1293:    ECMA_SET_NON_NULL_POINTER_TAG (reaction_values[0], result_capability_obj_p, tag);
        -: 1294:
    #####: 1295:    uint32_t value_count = (uint32_t) (reactions_p - reaction_values);
    #####: 1296:    ecma_collection_append (promise_p->reactions, reaction_values, value_count);
        -: 1297:  }
    #####: 1298:  else if (flags & ECMA_PROMISE_IS_FULFILLED)
        -: 1299:  {
        -: 1300:    /* 8. */
    #####: 1301:    ecma_value_t value = ecma_promise_get_result (promise_obj_p);
    #####: 1302:    ecma_enqueue_promise_reaction_job (ecma_make_object_value (result_capability_obj_p), on_fulfilled, value);
    #####: 1303:    ecma_free_value (value);
        -: 1304:  }
        -: 1305:  else
        -: 1306:  {
        -: 1307:    /* 9. */
    #####: 1308:    ecma_value_t reason = ecma_promise_get_result (promise_obj_p);
    #####: 1309:    ecma_enqueue_promise_reaction_job (ecma_make_object_value (result_capability_obj_p), on_rejected, reason);
    #####: 1310:    ecma_free_value (reason);
        -: 1311:
        -: 1312:#if JERRY_PROMISE_CALLBACK
    #####: 1313:    if (ecma_promise_get_flags (promise_obj_p) & ECMA_PROMISE_UNHANDLED_REJECT)
        -: 1314:    {
    #####: 1315:      promise_p->header.u.cls.u1.promise_flags &= (uint8_t) ~ECMA_PROMISE_UNHANDLED_REJECT;
        -: 1316:
    #####: 1317:      if (JERRY_UNLIKELY (JERRY_CONTEXT (promise_callback_filters) & JERRY_PROMISE_EVENT_FILTER_ERROR))
        -: 1318:      {
        -: 1319:        JERRY_ASSERT (JERRY_CONTEXT (promise_callback) != NULL);
    #####: 1320:        JERRY_CONTEXT (promise_callback)
        -: 1321:        (JERRY_PROMISE_EVENT_CATCH_HANDLER_ADDED,
        -: 1322:         promise,
        -: 1323:         ECMA_VALUE_UNDEFINED,
        -: 1324:         JERRY_CONTEXT (promise_callback_user_p));
        -: 1325:      }
        -: 1326:    }
        -: 1327:#endif /* JERRY_PROMISE_CALLBACK */
        -: 1328:  }
        -: 1329:
        -: 1330:  /* 10. */
    #####: 1331:  return ecma_copy_value (capability_p->header.u.cls.u3.promise);
        -: 1332:} /* ecma_promise_perform_then */
        -: 1333:
        -: 1334:/**
        -: 1335: * @}
        -: 1336: * @}
        -: 1337: */
        -: 1338:#endif /* JERRY_ESNEXT */
