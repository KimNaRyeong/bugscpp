        -:    0:Source:/home/workspace/jerry-core/parser/regexp/re-compiler.c
        -:    0:Programs:291
        -:    1:/* Copyright JS Foundation and other contributors, http://js.foundation
        -:    2: *
        -:    3: * Licensed under the Apache License, Version 2.0 (the "License");
        -:    4: * you may not use this file except in compliance with the License.
        -:    5: * You may obtain a copy of the License at
        -:    6: *
        -:    7: *     http://www.apache.org/licenses/LICENSE-2.0
        -:    8: *
        -:    9: * Unless required by applicable law or agreed to in writing, software
        -:   10: * distributed under the License is distributed on an "AS IS" BASIS
        -:   11: * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
        -:   12: * See the License for the specific language governing permissions and
        -:   13: * limitations under the License.
        -:   14: */
        -:   15:
        -:   16:#include "ecma-exceptions.h"
        -:   17:#include "ecma-helpers.h"
        -:   18:#include "ecma-regexp-object.h"
        -:   19:#include "lit-char-helpers.h"
        -:   20:#include "jcontext.h"
        -:   21:#include "jrt-libc-includes.h"
        -:   22:#include "jmem.h"
        -:   23:#include "re-bytecode.h"
        -:   24:#include "re-compiler.h"
        -:   25:#include "re-compiler-context.h"
        -:   26:#include "re-parser.h"
        -:   27:
        -:   28:#if JERRY_BUILTIN_REGEXP
        -:   29:
        -:   30:/** \addtogroup parser Parser
        -:   31: * @{
        -:   32: *
        -:   33: * \addtogroup regexparser Regular expression
        -:   34: * @{
        -:   35: *
        -:   36: * \addtogroup regexparser_compiler Compiler
        -:   37: * @{
        -:   38: */
        -:   39:
        -:   40:/**
        -:   41: * Search for the given pattern in the RegExp cache.
        -:   42: *
        -:   43: * @return pointer to bytecode if found
        -:   44: *         NULL - otherwise
        -:   45: */
        -:   46:static re_compiled_code_t *
    #####:   47:re_cache_lookup (ecma_string_t *pattern_str_p, /**< pattern string */
        -:   48:                 uint16_t flags) /**< flags */
        -:   49:{
    #####:   50:  re_compiled_code_t **cache_p = JERRY_CONTEXT (re_cache);
        -:   51:
    #####:   52:  for (uint8_t idx = 0u; idx < RE_CACHE_SIZE; idx++)
        -:   53:  {
    #####:   54:    re_compiled_code_t *cached_bytecode_p = cache_p[idx];
        -:   55:
    #####:   56:    if (cached_bytecode_p == NULL)
        -:   57:    {
    #####:   58:      break;
        -:   59:    }
        -:   60:
    #####:   61:    ecma_string_t *cached_pattern_str_p = ecma_get_string_from_value (cached_bytecode_p->source);
        -:   62:
    #####:   63:    if (cached_bytecode_p->header.status_flags == flags
    #####:   64:        && ecma_compare_ecma_strings (cached_pattern_str_p, pattern_str_p))
        -:   65:    {
    #####:   66:      return cached_bytecode_p;
        -:   67:    }
        -:   68:  }
        -:   69:
    #####:   70:  return NULL;
        -:   71:} /* re_cache_lookup */
        -:   72:
        -:   73:/**
        -:   74: * Run garbage collection in RegExp cache.
        -:   75: */
        -:   76:void
        1:   77:re_cache_gc (void)
        -:   78:{
        1:   79:  re_compiled_code_t **cache_p = JERRY_CONTEXT (re_cache);
        -:   80:
        1:   81:  for (uint32_t i = 0u; i < RE_CACHE_SIZE; i++)
        -:   82:  {
        1:   83:    const re_compiled_code_t *cached_bytecode_p = cache_p[i];
        -:   84:
        1:   85:    if (cached_bytecode_p == NULL)
        -:   86:    {
        1:   87:      break;
        -:   88:    }
        -:   89:
    #####:   90:    ecma_bytecode_deref ((ecma_compiled_code_t *) cached_bytecode_p);
    #####:   91:    cache_p[i] = NULL;
        -:   92:  }
        -:   93:
        1:   94:  JERRY_CONTEXT (re_cache_idx) = 0;
        1:   95:} /* re_cache_gc */
        -:   96:
        -:   97:/**
        -:   98: * Compilation of RegExp bytecode
        -:   99: *
        -:  100: * @return pointer to bytecode if compilation was successful
        -:  101: *         NULL - otherwise
        -:  102: */
        -:  103:re_compiled_code_t *
    #####:  104:re_compile_bytecode (ecma_string_t *pattern_str_p, /**< pattern */
        -:  105:                     uint16_t flags) /**< flags */
        -:  106:{
    #####:  107:  re_compiled_code_t *cached_bytecode_p = re_cache_lookup (pattern_str_p, flags);
        -:  108:
    #####:  109:  if (cached_bytecode_p != NULL)
        -:  110:  {
    #####:  111:    ecma_bytecode_ref ((ecma_compiled_code_t *) cached_bytecode_p);
    #####:  112:    return cached_bytecode_p;
        -:  113:  }
        -:  114:
    #####:  115:  re_compiler_ctx_t re_ctx;
    #####:  116:  re_ctx.flags = flags;
    #####:  117:  re_ctx.captures_count = 1;
    #####:  118:  re_ctx.non_captures_count = 0;
        -:  119:
    #####:  120:  re_initialize_regexp_bytecode (&re_ctx);
        -:  121:
    #####:  122:  ECMA_STRING_TO_UTF8_STRING (pattern_str_p, pattern_start_p, pattern_start_size);
        -:  123:
    #####:  124:  re_ctx.input_start_p = pattern_start_p;
    #####:  125:  re_ctx.input_curr_p = (lit_utf8_byte_t *) pattern_start_p;
    #####:  126:  re_ctx.input_end_p = pattern_start_p + pattern_start_size;
    #####:  127:  re_ctx.groups_count = -1;
        -:  128:
        -:  129:  /* Parse RegExp pattern */
    #####:  130:  ecma_value_t result = re_parse_alternative (&re_ctx, true);
        -:  131:
    #####:  132:  ECMA_FINALIZE_UTF8_STRING (pattern_start_p, pattern_start_size);
        -:  133:
    #####:  134:  if (ECMA_IS_VALUE_ERROR (result))
        -:  135:  {
        -:  136:    /* Compilation failed, free bytecode. */
    #####:  137:    jmem_heap_free_block (re_ctx.bytecode_start_p, re_ctx.bytecode_size);
    #####:  138:    return NULL;
        -:  139:  }
        -:  140:
        -:  141:  /* Align bytecode size to JMEM_ALIGNMENT so that it can be stored in the bytecode header. */
    #####:  142:  const uint32_t final_size = JERRY_ALIGNUP (re_ctx.bytecode_size, JMEM_ALIGNMENT);
    #####:  143:  re_compiled_code_t *re_compiled_code_p = (re_compiled_code_t *) jmem_heap_realloc_block (re_ctx.bytecode_start_p,
        -:  144:                                                                                           re_ctx.bytecode_size,
        -:  145:                                                                                           final_size);
        -:  146:
        -:  147:  /* Bytecoded will be inserted into the cache and returned to the caller, so refcount is implicitly set to 2. */
    #####:  148:  re_compiled_code_p->header.refs = 2;
    #####:  149:  re_compiled_code_p->header.size = (uint16_t) (final_size >> JMEM_ALIGNMENT_LOG);
    #####:  150:  re_compiled_code_p->header.status_flags = re_ctx.flags;
        -:  151:
    #####:  152:  ecma_ref_ecma_string (pattern_str_p);
    #####:  153:  re_compiled_code_p->source = ecma_make_string_value (pattern_str_p);
    #####:  154:  re_compiled_code_p->captures_count = re_ctx.captures_count;
    #####:  155:  re_compiled_code_p->non_captures_count = re_ctx.non_captures_count;
        -:  156:
        -:  157:#if JERRY_REGEXP_DUMP_BYTE_CODE
        -:  158:  if (JERRY_CONTEXT (jerry_init_flags) & JERRY_INIT_SHOW_REGEXP_OPCODES)
        -:  159:  {
        -:  160:    re_dump_bytecode (&re_ctx);
        -:  161:  }
        -:  162:#endif /* JERRY_REGEXP_DUMP_BYTE_CODE */
        -:  163:
    #####:  164:  uint8_t cache_idx = JERRY_CONTEXT (re_cache_idx);
        -:  165:
    #####:  166:  if (JERRY_CONTEXT (re_cache)[cache_idx] != NULL)
        -:  167:  {
    #####:  168:    ecma_bytecode_deref ((ecma_compiled_code_t *) JERRY_CONTEXT (re_cache)[cache_idx]);
        -:  169:  }
        -:  170:
    #####:  171:  JERRY_CONTEXT (re_cache)[cache_idx] = re_compiled_code_p;
    #####:  172:  JERRY_CONTEXT (re_cache_idx) = (uint8_t) (cache_idx + 1) % RE_CACHE_SIZE;
        -:  173:
    #####:  174:  return re_compiled_code_p;
        -:  175:} /* re_compile_bytecode */
        -:  176:
        -:  177:/**
        -:  178: * @}
        -:  179: * @}
        -:  180: * @}
        -:  181: */
        -:  182:
        -:  183:#endif /* JERRY_BUILTIN_REGEXP */
