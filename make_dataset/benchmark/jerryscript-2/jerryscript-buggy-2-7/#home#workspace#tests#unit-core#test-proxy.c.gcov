        -:    0:Source:/home/workspace/tests/unit-core/test-proxy.c
        -:    0:Programs:296
        -:    1:/* Copyright JS Foundation and other contributors, http://js.foundation
        -:    2: *
        -:    3: * Licensed under the Apache License, Version 2.0 (the "License");
        -:    4: * you may not use this file except in compliance with the License.
        -:    5: * You may obtain a copy of the License at
        -:    6: *
        -:    7: *     http://www.apache.org/licenses/LICENSE-2.0
        -:    8: *
        -:    9: * Unless required by applicable law or agreed to in writing, software
        -:   10: * distributed under the License is distributed on an "AS IS" BASIS
        -:   11: * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
        -:   12: * See the License for the specific language governing permissions and
        -:   13: * limitations under the License.
        -:   14: */
        -:   15:
        -:   16:#include "config.h"
        -:   17:#include "jerryscript.h"
        -:   18:
        -:   19:#include "test-common.h"
        -:   20:
        -:   21:/** Test in Proxy on C side. Equivalent test code in JS:
        -:   22:
        -:   23:var demo = 0.0;
        -:   24:
        -:   25:var target = {};
        -:   26:var handler = {
        -:   27:    get: function (target, name, recv) {
        -:   28:        assert (typeof (target) === 'object');
        -:   29:        assert (name === 'value');
        -:   30:        assert (typeof (recv) === 'object');
        -:   31:        return demo++;
        -:   32:    }
        -:   33:
        -:   34:    set: function (target, name, value, recv) {
        -:   35:        assert (typeof (target) === 'object');
        -:   36:        assert (name === 'value');
        -:   37:        assert (typeof (recv) === 'object');
        -:   38:        demo = 55;
        -:   39:        return demo;
        -:   40:    }
        -:   41:};
        -:   42:
        -:   43:var pdemo = new Proxy(target, handler);
        -:   44:
        -:   45:assert (pdemo.value === 1.0);
        -:   46:assert (pdemo.value === 1.0);
        -:   47:assert (pdemo.value === 2.0);
        -:   48:
        -:   49:pdemo.value = 55;
        -:   50:
        -:   51:assert (pdemo.value === 56);
        -:   52:
        -:   53:pdemo.value = 12;
        -:   54:
        -:   55:assert (pdemo.value === 13);
        -:   56: */
        -:   57:
        -:   58:static int demo_value = 0;
        -:   59:
        -:   60:static jerry_value_t
    #####:   61:handler_get (const jerry_call_info_t *call_info_p, /**< call information */
        -:   62:             const jerry_value_t args_p[], /**< function arguments */
        -:   63:             const jerry_length_t args_count) /**< number of function arguments */
        -:   64:{
        -:   65:  JERRY_UNUSED (call_info_p);
        -:   66:
    #####:   67:  TEST_ASSERT (args_count == 3);
    #####:   68:  TEST_ASSERT (jerry_value_is_object (args_p[0])); /* target */
    #####:   69:  TEST_ASSERT (jerry_value_is_string (args_p[1])); /* P */
    #####:   70:  TEST_ASSERT (jerry_value_is_object (args_p[2])); /* receiver */
        -:   71:
    #####:   72:  const char expected[] = "value";
        -:   73:  char buffer[10];
    #####:   74:  jerry_size_t copied = jerry_string_to_char_buffer (args_p[1], (jerry_char_t *) buffer, 10);
        -:   75:
    #####:   76:  TEST_ASSERT (copied == 5);
    #####:   77:  TEST_ASSERT (strncmp (expected, buffer, 5) == 0);
        -:   78:
    #####:   79:  demo_value++;
        -:   80:
    #####:   81:  return jerry_create_number (demo_value);
        -:   82:} /* handler_get */
        -:   83:
        -:   84:static jerry_value_t
    #####:   85:handler_set (const jerry_call_info_t *call_info_p, /**< call information */
        -:   86:             const jerry_value_t args_p[], /**< function arguments */
        -:   87:             const jerry_length_t args_count) /**< number of function arguments */
        -:   88:{
        -:   89:  JERRY_UNUSED (call_info_p);
        -:   90:  JERRY_UNUSED (args_p);
        -:   91:  JERRY_UNUSED (args_count);
        -:   92:
    #####:   93:  TEST_ASSERT (args_count == 4);
    #####:   94:  TEST_ASSERT (jerry_value_is_object (args_p[0])); /* target */
    #####:   95:  TEST_ASSERT (jerry_value_is_string (args_p[1])); /* P */
    #####:   96:  TEST_ASSERT (jerry_value_is_number (args_p[2])); /* V */
    #####:   97:  TEST_ASSERT (jerry_value_is_object (args_p[3])); /* receiver */
        -:   98:
    #####:   99:  const char expected[] = "value";
        -:  100:  char buffer[10];
    #####:  101:  jerry_size_t copied = jerry_string_to_char_buffer (args_p[1], (jerry_char_t *) buffer, 10);
        -:  102:
    #####:  103:  TEST_ASSERT (copied == 5);
    #####:  104:  TEST_ASSERT (strncmp (expected, buffer, 5) == 0);
        -:  105:
    #####:  106:  TEST_ASSERT (jerry_value_is_number (args_p[2]));
    #####:  107:  demo_value = (int) jerry_get_number_value (args_p[2]);
        -:  108:
    #####:  109:  return jerry_create_number (demo_value);
        -:  110:} /* handler_set */
        -:  111:
        -:  112:static void
    #####:  113:set_property (jerry_value_t target, /**< target object */
        -:  114:              const char *name_p, /**< name of the property */
        -:  115:              jerry_value_t value) /**< value of the property */
        -:  116:{
    #####:  117:  jerry_value_t name_val = jerry_create_string ((const jerry_char_t *) name_p);
    #####:  118:  jerry_value_t result_val = jerry_set_property (target, name_val, value);
        -:  119:
    #####:  120:  TEST_ASSERT (jerry_value_is_boolean (result_val));
    #####:  121:  TEST_ASSERT (jerry_value_is_true (result_val));
    #####:  122:  jerry_release_value (name_val);
    #####:  123:} /* set_property */
        -:  124:
        -:  125:static jerry_value_t
    #####:  126:get_property (jerry_value_t target, /**< target object */
        -:  127:              const char *name_p) /**< name of the property */
        -:  128:{
    #####:  129:  jerry_value_t name_val = jerry_create_string ((const jerry_char_t *) name_p);
    #####:  130:  jerry_value_t result_val = jerry_get_property (target, name_val);
        -:  131:
    #####:  132:  TEST_ASSERT (!jerry_value_is_error (result_val));
    #####:  133:  jerry_release_value (name_val);
    #####:  134:  return result_val;
        -:  135:} /* get_property */
        -:  136:
        -:  137:static void
    #####:  138:set_function (jerry_value_t target, /**< target object */
        -:  139:              const char *name_p, /**< name of the function */
        -:  140:              jerry_external_handler_t handler_p) /**< function callback */
        -:  141:{
    #####:  142:  jerry_value_t function_val = jerry_create_external_function (handler_p);
    #####:  143:  set_property (target, name_p, function_val);
    #####:  144:  jerry_release_value (function_val);
    #####:  145:} /* set_function */
        -:  146:
        -:  147:struct test_data
        -:  148:{
        -:  149:  int value;
        -:  150:};
        -:  151:
        -:  152:static void
    #####:  153:proxy_native_freecb (void *native_p, /**< native pointer */
        -:  154:                     jerry_object_native_info_t *info_p) /**< native info */
        -:  155:{
    #####:  156:  TEST_ASSERT (native_p != NULL);
    #####:  157:  TEST_ASSERT (info_p->free_cb == proxy_native_freecb);
    #####:  158:  struct test_data *data_p = (struct test_data *) native_p;
    #####:  159:  data_p->value = -1;
    #####:  160:} /* proxy_native_freecb */
        -:  161:
        -:  162:static const jerry_object_native_info_t proxy_native_info =
        -:  163:{
        -:  164:  .free_cb = proxy_native_freecb,
        -:  165:  .number_of_references = 0,
        -:  166:  .offset_of_references = 0,
        -:  167:};
        -:  168:
        -:  169:static jerry_value_t
    #####:  170:proxy_native_handler_get (const jerry_call_info_t *call_info_p, /**< call information */
        -:  171:                          const jerry_value_t args_p[], /**< function arguments */
        -:  172:                          const jerry_length_t args_count) /**< number of function arguments */
        -:  173:{
        -:  174:  JERRY_UNUSED (call_info_p);
    #####:  175:  TEST_ASSERT (args_count == 3);
        -:  176:
        -:  177:  /* 3rd argument (Receiver) should be the Proxy here. */
    #####:  178:  jerry_value_t receiver = args_p[2];
    #####:  179:  TEST_ASSERT (jerry_value_is_proxy (receiver));
        -:  180:
        -:  181:  /* Check if proxy has the native ptr. */
        -:  182:  struct test_data *native_p;
    #####:  183:  bool has_p = jerry_get_object_native_pointer (receiver, (void *) &native_p, &proxy_native_info);
    #####:  184:  TEST_ASSERT (has_p == true);
        -:  185:
    #####:  186:  native_p->value <<= 1;
    #####:  187:  return jerry_create_number (native_p->value);
        -:  188:} /* proxy_native_handler_get */
        -:  189:
        -:  190:/**
        -:  191: * Test Proxy with added native object.
        -:  192: */
        -:  193:static void
    #####:  194:test_proxy_native (void)
        -:  195:{
    #####:  196:  jerry_value_t handler = jerry_create_object ();
    #####:  197:  set_function (handler, "get", proxy_native_handler_get);
        -:  198:
    #####:  199:  jerry_value_t target = jerry_create_object ();
    #####:  200:  jerry_value_t proxy = jerry_create_proxy (target, handler);
        -:  201:
    #####:  202:  struct test_data *data = (struct test_data *) malloc (sizeof (struct test_data));
    #####:  203:  data->value = 2;
    #####:  204:  jerry_set_object_native_pointer (proxy, data, &proxy_native_info);
        -:  205:
        -:  206:  /* Call: proxy[10] */
    #####:  207:  jerry_value_t result_for_10 = jerry_get_property_by_index (proxy, 10);
    #####:  208:  TEST_ASSERT (jerry_value_is_number (result_for_10));
    #####:  209:  TEST_ASSERT (jerry_get_number_value (result_for_10) == 4.0);
        -:  210:
        -:  211:  /* Call: proxy[5] */
    #####:  212:  data->value = 8;
    #####:  213:  jerry_value_t result_for_5 = jerry_get_property_by_index (proxy, 5);
    #####:  214:  TEST_ASSERT (jerry_value_is_number (result_for_5));
    #####:  215:  TEST_ASSERT (jerry_get_number_value (result_for_5) == 16.0);
        -:  216:
    #####:  217:  jerry_release_value (handler);
    #####:  218:  jerry_release_value (target);
    #####:  219:  jerry_release_value (proxy);
    #####:  220:} /* test_proxy_native */
        -:  221:
        -:  222:int
    #####:  223:main (void)
        -:  224:{
    #####:  225:  TEST_INIT ();
        -:  226:
    #####:  227:  if (!jerry_is_feature_enabled (JERRY_FEATURE_PROXY))
        -:  228:  {
    #####:  229:    printf ("Skipping test, Proxy not enabled\n");
    #####:  230:    return 0;
        -:  231:  }
        -:  232:
    #####:  233:  jerry_init (JERRY_INIT_EMPTY);
        -:  234:
    #####:  235:  jerry_value_t handler = jerry_create_object ();
        -:  236:  {
    #####:  237:    set_function (handler, "get", handler_get);
    #####:  238:    set_function (handler, "set", handler_set);
        -:  239:  }
        -:  240:
    #####:  241:  jerry_value_t target = jerry_create_object ();
    #####:  242:  jerry_value_t proxy = jerry_create_proxy (target, handler);
        -:  243:  {
    #####:  244:    jerry_value_t global = jerry_get_global_object ();
    #####:  245:    set_property (global, "pdemo", proxy);
    #####:  246:    jerry_release_value (global);
        -:  247:  }
        -:  248:
    #####:  249:  const jerry_char_t get_value_src[] = TEST_STRING_LITERAL ("pdemo.value");
    #####:  250:  jerry_value_t parsed_get_code_val = jerry_parse (get_value_src,
        -:  251:                                                   sizeof (get_value_src) - 1,
        -:  252:                                                   NULL);
    #####:  253:  TEST_ASSERT (!jerry_value_is_error (parsed_get_code_val));
        -:  254:
        -:  255:  {
    #####:  256:    jerry_value_t res = jerry_run (parsed_get_code_val);
    #####:  257:    TEST_ASSERT (jerry_value_is_number (res));
    #####:  258:    TEST_ASSERT (jerry_get_number_value (res) == 1.0);
    #####:  259:    jerry_release_value (res);
        -:  260:  }
        -:  261:
        -:  262:  {
    #####:  263:    jerry_value_t res = get_property (proxy, "value");
    #####:  264:    TEST_ASSERT (jerry_value_is_number (res));
    #####:  265:    TEST_ASSERT (jerry_get_number_value (res) == 2.0);
    #####:  266:    jerry_release_value (res);
        -:  267:  }
        -:  268:
        -:  269:  {
    #####:  270:    jerry_value_t res = jerry_run (parsed_get_code_val);
    #####:  271:    TEST_ASSERT (jerry_value_is_number (res));
    #####:  272:    TEST_ASSERT (jerry_get_number_value (res) == 3.0);
    #####:  273:    jerry_release_value (res);
        -:  274:  }
        -:  275:
    #####:  276:  const jerry_char_t set_value_src[] = TEST_STRING_LITERAL ("pdemo.value = 55");
    #####:  277:  jerry_value_t parsed_set_code_val = jerry_parse (set_value_src,
        -:  278:                                                   sizeof (set_value_src) - 1,
        -:  279:                                                   NULL);
    #####:  280:  TEST_ASSERT (!jerry_value_is_error (parsed_set_code_val));
        -:  281:
        -:  282:  {
    #####:  283:    jerry_value_t res = jerry_run (parsed_set_code_val);
    #####:  284:    TEST_ASSERT (jerry_value_is_number (res));
    #####:  285:    TEST_ASSERT (jerry_get_number_value (res) == 55);
    #####:  286:    jerry_release_value (res);
        -:  287:  }
        -:  288:
        -:  289:  {
    #####:  290:    jerry_value_t res = jerry_run (parsed_get_code_val);
    #####:  291:    TEST_ASSERT (jerry_value_is_number (res));
    #####:  292:    TEST_ASSERT (jerry_get_number_value (res) == 56);
    #####:  293:    jerry_release_value (res);
        -:  294:  }
        -:  295:
        -:  296:  {
    #####:  297:    jerry_value_t new_value = jerry_create_number (12);
    #####:  298:    set_property (proxy, "value", new_value);
    #####:  299:    jerry_release_value (new_value);
        -:  300:  }
        -:  301:
        -:  302:  {
    #####:  303:    jerry_value_t res = get_property (proxy, "value");
    #####:  304:    TEST_ASSERT (jerry_value_is_number (res));
    #####:  305:    TEST_ASSERT (jerry_get_number_value (res) == 13.0);
    #####:  306:    jerry_release_value (res);
        -:  307:  }
        -:  308:
    #####:  309:  jerry_release_value (parsed_set_code_val);
    #####:  310:  jerry_release_value (parsed_get_code_val);
    #####:  311:  jerry_release_value (proxy);
    #####:  312:  jerry_release_value (target);
    #####:  313:  jerry_release_value (handler);
        -:  314:
        -:  315:  {
    #####:  316:    const jerry_char_t has_value_src[] = TEST_STRING_LITERAL ("new Proxy({}, {\n"
        -:  317:                                                              "  has: function(target, key) { throw 33 }\n"
        -:  318:                                                              "})");
    #####:  319:    jerry_value_t parsed_has_code_val = jerry_parse (has_value_src,
        -:  320:                                                     sizeof (has_value_src) - 1,
        -:  321:                                                     NULL);
    #####:  322:    TEST_ASSERT (!jerry_value_is_error (parsed_has_code_val));
        -:  323:
    #####:  324:    jerry_value_t res = jerry_run (parsed_has_code_val);
    #####:  325:    jerry_release_value (parsed_has_code_val);
    #####:  326:    TEST_ASSERT (jerry_value_is_proxy (res));
        -:  327:
    #####:  328:    jerry_value_t name = jerry_create_string ((const jerry_char_t *) "key");
    #####:  329:    TEST_ASSERT (jerry_value_is_string (name));
    #####:  330:    jerry_value_t property = jerry_has_property (res, name);
    #####:  331:    jerry_release_value (name);
    #####:  332:    jerry_release_value (res);
        -:  333:
    #####:  334:    TEST_ASSERT (jerry_value_is_error (property));
    #####:  335:    property = jerry_get_value_from_error (property, true);
    #####:  336:    TEST_ASSERT (jerry_get_number_value (property) == 33);
    #####:  337:    jerry_release_value (property);
        -:  338:  }
        -:  339:
    #####:  340:  target = jerry_create_object ();
    #####:  341:  handler = jerry_create_object ();
    #####:  342:  proxy = jerry_create_proxy (target, handler);
        -:  343:
        -:  344:  {
    #####:  345:    jerry_value_t res = jerry_get_proxy_target (proxy);
    #####:  346:    TEST_ASSERT (res == target);
    #####:  347:    jerry_release_value (res);
        -:  348:
    #####:  349:    res = jerry_get_proxy_handler (proxy);
    #####:  350:    TEST_ASSERT (res == handler);
    #####:  351:    jerry_release_value (res);
        -:  352:
    #####:  353:    res = jerry_get_proxy_target (target);
    #####:  354:    TEST_ASSERT (jerry_value_is_error (res));
    #####:  355:    res = jerry_get_value_from_error (res, true);
    #####:  356:    TEST_ASSERT (jerry_get_error_type (res) == JERRY_ERROR_TYPE);
    #####:  357:    jerry_release_value (res);
        -:  358:
    #####:  359:    res = jerry_get_proxy_handler (handler);
    #####:  360:    TEST_ASSERT (jerry_value_is_error (res));
    #####:  361:    res = jerry_get_value_from_error (res, true);
    #####:  362:    TEST_ASSERT (jerry_get_error_type (res) == JERRY_ERROR_TYPE);
    #####:  363:    jerry_release_value (res);
        -:  364:  }
        -:  365:
    #####:  366:  jerry_release_value (proxy);
    #####:  367:  jerry_release_value (handler);
    #####:  368:  jerry_release_value (target);
        -:  369:
    #####:  370:  test_proxy_native ();
        -:  371:
    #####:  372:  jerry_cleanup ();
    #####:  373:  return 0;
        -:  374:} /* main */
