        -:    0:Source:/home/workspace/tests/unit-core/test-promise-callback.c
        -:    0:Programs:296
        -:    1:/* Copyright JS Foundation and other contributors, http://js.foundation
        -:    2: *
        -:    3: * Licensed under the Apache License, Version 2.0 (the "License");
        -:    4: * you may not use this file except in compliance with the License.
        -:    5: * You may obtain a copy of the License at
        -:    6: *
        -:    7: *     http://www.apache.org/licenses/LICENSE-2.0
        -:    8: *
        -:    9: * Unless required by applicable law or agreed to in writing, software
        -:   10: * distributed under the License is distributed on an "AS IS" BASIS
        -:   11: * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
        -:   12: * See the License for the specific language governing permissions and
        -:   13: * limitations under the License.
        -:   14: */
        -:   15:
        -:   16:#include "jerryscript.h"
        -:   17:
        -:   18:#include "test-common.h"
        -:   19:
        -:   20:/* Note: RS = ReSolve, RJ = ReJect */
        -:   21:typedef enum
        -:   22:{
        -:   23:  C = JERRY_PROMISE_EVENT_CREATE, /**< same as JERRY_PROMISE_CALLBACK_CREATE with undefined value */
        -:   24:  RS = JERRY_PROMISE_EVENT_RESOLVE, /**< same as JERRY_PROMISE_CALLBACK_RESOLVE */
        -:   25:  RJ = JERRY_PROMISE_EVENT_REJECT, /**< same as JERRY_PROMISE_CALLBACK_REJECT */
        -:   26:  RSF = JERRY_PROMISE_EVENT_RESOLVE_FULFILLED, /**< same as JERRY_PROMISE_EVENT_RESOLVE_FULFILLED */
        -:   27:  RJF = JERRY_PROMISE_EVENT_REJECT_FULFILLED, /**< same as JERRY_PROMISE_EVENT_REJECT_FULFILLED */
        -:   28:  RWH = JERRY_PROMISE_EVENT_REJECT_WITHOUT_HANDLER, /**< same as JERRY_PROMISE_EVENT_REJECT_WITHOUT_HANDLER */
        -:   29:  CHA = JERRY_PROMISE_EVENT_CATCH_HANDLER_ADDED, /**< same as JERRY_PROMISE_EVENT_CATCH_HANDLER_ADDED */
        -:   30:  BR = JERRY_PROMISE_EVENT_BEFORE_REACTION_JOB, /**< same as JERRY_PROMISE_CALLBACK_BEFORE_REACTION_JOB */
        -:   31:  AR = JERRY_PROMISE_EVENT_AFTER_REACTION_JOB, /**< same as JERRY_PROMISE_CALLBACK_AFTER_REACTION_JOB */
        -:   32:  A = JERRY_PROMISE_EVENT_ASYNC_AWAIT, /**< same as JERRY_PROMISE_CALLBACK_ASYNC_AWAIT */
        -:   33:  BRS = JERRY_PROMISE_EVENT_ASYNC_BEFORE_RESOLVE, /**< same as JERRY_PROMISE_CALLBACK_ASYNC_BEFORE_RESOLVE */
        -:   34:  BRJ = JERRY_PROMISE_EVENT_ASYNC_BEFORE_REJECT, /**< same as JERRY_PROMISE_CALLBACK_ASYNC_BEFORE_REJECT */
        -:   35:  ARS = JERRY_PROMISE_EVENT_ASYNC_AFTER_RESOLVE, /**< same as JERRY_PROMISE_CALLBACK_ASYNC_AFTER_RESOLVE */
        -:   36:  ARJ = JERRY_PROMISE_EVENT_ASYNC_AFTER_REJECT, /**< same as JERRY_PROMISE_CALLBACK_ASYNC_AFTER_REJECT */
        -:   37:  CP = UINT8_MAX - 1, /**< same as JERRY_PROMISE_CALLBACK_CREATE with Promise value */
        -:   38:  E = UINT8_MAX, /**< marks the end of the event list */
        -:   39:} jerry_promise_callback_event_abbreviations_t;
        -:   40:
        -:   41:static int user;
        -:   42:static const uint8_t *next_event_p;
        -:   43:
        -:   44:static void
    #####:   45:promise_callback (jerry_promise_event_type_t event_type, /**< event type */
        -:   46:                  const jerry_value_t object, /**< target object */
        -:   47:                  const jerry_value_t value, /**< optional argument */
        -:   48:                  void *user_p) /**< user pointer passed to the callback */
        -:   49:{
    #####:   50:  TEST_ASSERT (user_p == (void *) &user);
        -:   51:
    #####:   52:  switch (event_type)
        -:   53:  {
    #####:   54:    case JERRY_PROMISE_EVENT_CREATE:
        -:   55:    {
    #####:   56:      TEST_ASSERT (jerry_value_is_promise (object));
    #####:   57:      if (jerry_value_is_undefined (value))
        -:   58:      {
        -:   59:        break;
        -:   60:      }
        -:   61:
    #####:   62:      TEST_ASSERT (jerry_value_is_promise (value));
    #####:   63:      TEST_ASSERT (*next_event_p++ == CP);
        -:   64:      return;
        -:   65:    }
    #####:   66:    case JERRY_PROMISE_EVENT_RESOLVE:
        -:   67:    case JERRY_PROMISE_EVENT_REJECT:
        -:   68:    case JERRY_PROMISE_EVENT_RESOLVE_FULFILLED:
        -:   69:    case JERRY_PROMISE_EVENT_REJECT_FULFILLED:
        -:   70:    case JERRY_PROMISE_EVENT_REJECT_WITHOUT_HANDLER:
        -:   71:    {
    #####:   72:      TEST_ASSERT (jerry_value_is_promise (object));
        -:   73:      break;
        -:   74:    }
    #####:   75:    case JERRY_PROMISE_EVENT_CATCH_HANDLER_ADDED:
        -:   76:    case JERRY_PROMISE_EVENT_BEFORE_REACTION_JOB:
        -:   77:    case JERRY_PROMISE_EVENT_AFTER_REACTION_JOB:
        -:   78:    {
    #####:   79:      TEST_ASSERT (jerry_value_is_promise (object));
    #####:   80:      TEST_ASSERT (jerry_value_is_undefined (value));
        -:   81:      break;
        -:   82:    }
    #####:   83:    case JERRY_PROMISE_EVENT_ASYNC_AWAIT:
        -:   84:    {
    #####:   85:      TEST_ASSERT (jerry_value_is_object (object));
    #####:   86:      TEST_ASSERT (jerry_value_is_promise (value));
        -:   87:      break;
        -:   88:    }
    #####:   89:    default:
        -:   90:    {
    #####:   91:      TEST_ASSERT (event_type == JERRY_PROMISE_EVENT_ASYNC_BEFORE_RESOLVE
        -:   92:                   || event_type == JERRY_PROMISE_EVENT_ASYNC_BEFORE_REJECT
        -:   93:                   || event_type == JERRY_PROMISE_EVENT_ASYNC_AFTER_RESOLVE
        -:   94:                   || event_type == JERRY_PROMISE_EVENT_ASYNC_AFTER_REJECT);
    #####:   95:      TEST_ASSERT (jerry_value_is_object (object));
        -:   96:      break;
        -:   97:    }
        -:   98:  }
        -:   99:
    #####:  100:  TEST_ASSERT (*next_event_p++ == (uint8_t) event_type);
        -:  101:} /* promise_callback */
        -:  102:
        -:  103:static void
    #####:  104:run_eval (const uint8_t *event_list_p, /**< event list */
        -:  105:          const char *source_p) /**< source code */
        -:  106:{
    #####:  107:  next_event_p = event_list_p;
        -:  108:
    #####:  109:  jerry_value_t result = jerry_eval ((const jerry_char_t *) source_p, strlen (source_p), 0);
        -:  110:
    #####:  111:  TEST_ASSERT (!jerry_value_is_error (result));
    #####:  112:  jerry_release_value (result);
        -:  113:
    #####:  114:  result = jerry_run_all_enqueued_jobs ();
    #####:  115:  TEST_ASSERT (!jerry_value_is_error (result));
    #####:  116:  jerry_release_value (result);
        -:  117:
    #####:  118:  TEST_ASSERT (*next_event_p == UINT8_MAX);
    #####:  119:} /* run_eval */
        -:  120:
        -:  121:int
    #####:  122:main (void)
        -:  123:{
    #####:  124:  TEST_INIT ();
        -:  125:
    #####:  126:  if (!jerry_is_feature_enabled (JERRY_FEATURE_PROMISE))
        -:  127:  {
    #####:  128:    jerry_port_log (JERRY_LOG_LEVEL_ERROR, "Promise is disabled!\n");
    #####:  129:    return 0;
        -:  130:  }
        -:  131:
        -:  132:  /* The test system enables this feature when Promises are enabled. */
    #####:  133:  TEST_ASSERT (jerry_is_feature_enabled (JERRY_FEATURE_PROMISE_CALLBACK));
        -:  134:
    #####:  135:  jerry_init (JERRY_INIT_EMPTY);
        -:  136:
    #####:  137:  jerry_promise_event_filter_t filters = (JERRY_PROMISE_EVENT_FILTER_CREATE
        -:  138:                                          | JERRY_PROMISE_EVENT_FILTER_RESOLVE
        -:  139:                                          | JERRY_PROMISE_EVENT_FILTER_REJECT
        -:  140:                                          | JERRY_PROMISE_EVENT_FILTER_ERROR
        -:  141:                                          | JERRY_PROMISE_EVENT_FILTER_REACTION_JOB
        -:  142:                                          | JERRY_PROMISE_EVENT_FILTER_ASYNC_MAIN
        -:  143:                                          | JERRY_PROMISE_EVENT_FILTER_ASYNC_REACTION_JOB);
        -:  144:
    #####:  145:  jerry_promise_set_callback (filters, promise_callback, (void *) &user);
        -:  146:
        -:  147:  /* Test promise creation. */
        -:  148:  static uint8_t events1[] = { C, C, C, E };
        -:  149:
    #####:  150:  run_eval (events1,
        -:  151:            "'use strict'\n"
        -:  152:            "new Promise((res, rej) => {})\n"
        -:  153:            "new Promise((res, rej) => {})\n"
        -:  154:            "new Promise((res, rej) => {})\n");
        -:  155:
        -:  156:  /* Test then call. */
        -:  157:  static uint8_t events2[] = { C, CP, E };
        -:  158:
    #####:  159:  run_eval (events2,
        -:  160:            "'use strict'\n"
        -:  161:            "var promise = new Promise((res, rej) => {})\n"
        -:  162:            "promise.then(() => {}, () => {})\n");
        -:  163:
        -:  164:  /* Test then call with extended Promise. */
        -:  165:  static uint8_t events3[] = { C, C, E };
        -:  166:
    #####:  167:  run_eval (events3,
        -:  168:            "'use strict'\n"
        -:  169:            "var P = class extends Promise {}\n"
        -:  170:            "var promise = new P((res, rej) => {})\n"
        -:  171:            "promise.then(() => {})\n");
        -:  172:
        -:  173:  /* Test resolve and reject calls. */
        -:  174:  static uint8_t events4[] = { C, C, RS, RJ, RWH, E };
        -:  175:
    #####:  176:  run_eval (events4,
        -:  177:            "'use strict'\n"
        -:  178:            "var resolve\n"
        -:  179:            "var reject\n"
        -:  180:            "new Promise((res, rej) => resolve = res)\n"
        -:  181:            "new Promise((res, rej) => reject = rej)\n"
        -:  182:            "resolve(1)\n"
        -:  183:            "reject(1)\n");
        -:  184:
        -:  185:  /* Test then and resolve calls. */
        -:  186:  static uint8_t events5[] = { C, CP, RS, BR, RS, AR, E };
        -:  187:
    #####:  188:  run_eval (events5,
        -:  189:            "'use strict'\n"
        -:  190:            "var resolve\n"
        -:  191:            "var promise = new Promise((res, rej) => resolve = res)\n"
        -:  192:            "promise.then(() => {})\n"
        -:  193:            "resolve(1)\n");
        -:  194:
        -:  195:  /* Test resolve and then calls. */
        -:  196:  static uint8_t events6[] = { C, RS, CP, BR, RS, AR, E };
        -:  197:
    #####:  198:  run_eval (events6,
        -:  199:            "'use strict'\n"
        -:  200:            "var promise = new Promise((res, rej) => res(1))\n"
        -:  201:            "promise.then(() => {})\n");
        -:  202:
        -:  203:  /* Test Promise.resolve. */
        -:  204:  static uint8_t events7[] = { C, RS, CP, BR, RS, AR, E };
        -:  205:
    #####:  206:  run_eval (events7,
        -:  207:            "Promise.resolve(4).then(() => {})\n");
        -:  208:
        -:  209:  /* Test Promise.reject. */
        -:  210:  static uint8_t events8[] = { C, RJ, RWH, CP, CHA, BR, RJ, RWH, AR, E };
        -:  211:
    #####:  212:  run_eval (events8,
        -:  213:            "Promise.reject(4).catch(() => { throw 'Error' })\n");
        -:  214:
        -:  215:  /* Test Promise.race without resolve */
        -:  216:  static uint8_t events9[] = { C, C, C, CP, CP, E };
        -:  217:
    #####:  218:  run_eval (events9,
        -:  219:            "'use strict'\n"
        -:  220:            "var p1 = new Promise((res, rej) => {})\n"
        -:  221:            "var p2 = new Promise((res, rej) => {})\n"
        -:  222:            "Promise.race([p1,p2])\n");
        -:  223:
        -:  224:  /* Test Promise.race with resolve. */
        -:  225:  static uint8_t events10[] = { C, RS, C, RJ, RWH, C, CP, CP, CHA, BR, RS, RS, AR, BR, RJF, RS, AR, E };
        -:  226:
    #####:  227:  run_eval (events10,
        -:  228:            "'use strict'\n"
        -:  229:            "var p1 = new Promise((res, rej) => res(1))\n"
        -:  230:            "var p2 = new Promise((res, rej) => rej(1))\n"
        -:  231:            "Promise.race([p1,p2])\n");
        -:  232:
        -:  233:  /* Test Promise.all without resolve. */
        -:  234:  static uint8_t events11[] = { C, C, C, CP, CP, E };
        -:  235:
    #####:  236:  run_eval (events11,
        -:  237:            "'use strict'\n"
        -:  238:            "var p1 = new Promise((res, rej) => {})\n"
        -:  239:            "var p2 = new Promise((res, rej) => {})\n"
        -:  240:            "Promise.all([p1,p2])\n");
        -:  241:
        -:  242:  /* Test Promise.all with resolve. */
        -:  243:  static uint8_t events12[] = { C, RS, C, RJ, RWH, C, CP, CP, CHA, BR, RS, AR, BR, RJ, RWH, RS, AR, E };
        -:  244:
    #####:  245:  run_eval (events12,
        -:  246:            "'use strict'\n"
        -:  247:            "var p1 = new Promise((res, rej) => res(1))\n"
        -:  248:            "var p2 = new Promise((res, rej) => rej(1))\n"
        -:  249:            "Promise.all([p1,p2])\n");
        -:  250:
        -:  251:  /* Test async function. */
        -:  252:  static uint8_t events13[] = { C, RS, E };
        -:  253:
    #####:  254:  run_eval (events13,
        -:  255:            "'use strict'\n"
        -:  256:            "async function f() {}\n"
        -:  257:            "f()\n");
        -:  258:
        -:  259:  /* Test await with resolved Promise. */
        -:  260:  static uint8_t events14[] = { C, RS, A, C, BRS, RS, ARS, E };
        -:  261:
    #####:  262:  run_eval (events14,
        -:  263:            "'use strict'\n"
        -:  264:            "async function f(p) { await p }\n"
        -:  265:            "f(Promise.resolve(1))\n");
        -:  266:
        -:  267:  /* Test await with non-Promise value. */
        -:  268:  static uint8_t events15[] = { C, RS, A, C, BRS, C, RS, A, ARS, BRS, RS, ARS, E };
        -:  269:
    #####:  270:  run_eval (events15,
        -:  271:            "'use strict'\n"
        -:  272:            "async function f(p) { await p; await 'X' }\n"
        -:  273:            "f(Promise.resolve(1))\n");
        -:  274:
        -:  275:  /* Test await with rejected Promise. */
        -:  276:  static uint8_t events16[] = { C, RJ, RWH, A, CHA, C, BRJ, C, RS, RS, ARJ, E };
        -:  277:
    #####:  278:  run_eval (events16,
        -:  279:            "'use strict'\n"
        -:  280:            "async function f(p) { try { await p; } catch (e) { Promise.resolve(1) } }\n"
        -:  281:            "f(Promise.reject(1))\n");
        -:  282:
        -:  283:  /* Test async generator function. */
        -:  284:  static uint8_t events17[] = { C, RS, C, A, BRS, RS, ARS, E };
        -:  285:
    #####:  286:  run_eval (events17,
        -:  287:            "'use strict'\n"
        -:  288:            "async function *f(p) { await p; return 4 }\n"
        -:  289:            "f(Promise.resolve(1)).next()\n");
        -:  290:
        -:  291:  /* Test yield* operation. */
        -:  292:  static uint8_t events18[] = { C, C, RS, A, BRS, C, RS, A, ARS, BRS, RS, ARS, E };
        -:  293:
    #####:  294:  run_eval (events18,
        -:  295:            "'use strict'\n"
        -:  296:            "async function *f(p) { yield 1 }\n"
        -:  297:            "async function *g() { yield* f() }\n"
        -:  298:            "g().next()\n");
        -:  299:
        -:  300:  /* Test multiple fulfill operations. */
        -:  301:  static uint8_t events19[] = { C, RS, RSF, RJF, E };
        -:  302:
    #####:  303:  run_eval (events19,
        -:  304:            "'use strict'\n"
        -:  305:            "var resolve, reject\n"
        -:  306:            "var p1 = new Promise((res, rej) => { resolve = res, reject = rej })\n"
        -:  307:            "resolve(1)\n"
        -:  308:            "resolve(2)\n"
        -:  309:            "reject(3)\n");
        -:  310:
        -:  311:  /* Test multiple fulfill operations. */
        -:  312:  static uint8_t events20[] = { C, RJ, RWH, RSF, RJF, E };
        -:  313:
    #####:  314:  run_eval (events20,
        -:  315:            "'use strict'\n"
        -:  316:            "var resolve, reject\n"
        -:  317:            "var p1 = new Promise((res, rej) => { resolve = res, reject = rej })\n"
        -:  318:            "reject(1)\n"
        -:  319:            "resolve(2)\n"
        -:  320:            "reject(3)\n");
        -:  321:
        -:  322:  /* Test catch handler added later is reported only once. */
        -:  323:  static uint8_t events21[] = { C, RJ, RWH, CP, CHA, CP, CP, BR, RS, AR, BR, RS, AR, BR, RS, AR, E };
        -:  324:
    #####:  325:  run_eval (events21,
        -:  326:            "'use strict'\n"
        -:  327:            "var rej = Promise.reject(4)\n"
        -:  328:            "rej.catch(() => {})\n"
        -:  329:            "rej.catch(() => {})\n"
        -:  330:            "rej.catch(() => {})\n");
        -:  331:
        -:  332:  /* Test catch handler added later is reported only once. */
        -:  333:  static uint8_t events22[] = { C, RJ, RWH, A, CHA, C, BRJ, A, ARJ, BRJ, RJ, RWH, ARJ, E };
        -:  334:
    #####:  335:  run_eval (events22,
        -:  336:            "'use strict'\n"
        -:  337:            "async function f(p) { try { await p; } catch(e) { await p; } }"
        -:  338:            "f(Promise.reject(4))\n");
        -:  339:
        -:  340:  /* Test chained then. */
        -:  341:  static uint8_t events23[] = { C, RJ, RWH, CP, CHA, CP, BR, RJ, AR, BR, RS, AR, E };
        -:  342:
    #####:  343:  run_eval (events23,
        -:  344:            "'use strict'\n"
        -:  345:            "var p = Promise.reject(0)\n"
        -:  346:            "p.then(() => {}).catch(() => {})\n");
        -:  347:
        -:  348:  /* Test disabled filters. */
    #####:  349:  jerry_promise_set_callback (JERRY_PROMISE_EVENT_FILTER_DISABLE, promise_callback, (void *) &user);
        -:  350:
        -:  351:  static uint8_t events24[] = { E };
        -:  352:
    #####:  353:  run_eval (events24,
        -:  354:            "'use strict'\n"
        -:  355:            "async function f(p) { await p }"
        -:  356:            "f(Promise.resolve(1))\n");
        -:  357:
        -:  358:  /* Test filtered events. */
    #####:  359:  filters = JERRY_PROMISE_EVENT_FILTER_REACTION_JOB | JERRY_PROMISE_EVENT_FILTER_ASYNC_REACTION_JOB;
    #####:  360:  jerry_promise_set_callback (filters, promise_callback, (void *) &user);
        -:  361:
        -:  362:  static uint8_t events25[] = { BR, AR, BRS, ARS, E };
        -:  363:
    #####:  364:  run_eval (events25,
        -:  365:            "'use strict'\n"
        -:  366:            "async function f(p) { await p }"
        -:  367:            "f(Promise.resolve(1).then(() => {}))\n");
        -:  368:
    #####:  369:  jerry_cleanup ();
    #####:  370:  return 0;
        -:  371:} /* main */
