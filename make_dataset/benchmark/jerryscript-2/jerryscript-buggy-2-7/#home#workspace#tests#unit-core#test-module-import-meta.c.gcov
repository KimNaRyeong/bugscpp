        -:    0:Source:/home/workspace/tests/unit-core/test-module-import-meta.c
        -:    0:Programs:296
        -:    1:/* Copyright JS Foundation and other contributors, http://js.foundation
        -:    2: *
        -:    3: * Licensed under the Apache License, Version 2.0 (the "License");
        -:    4: * you may not use this file except in compliance with the License.
        -:    5: * You may obtain a copy of the License at
        -:    6: *
        -:    7: *     http://www.apache.org/licenses/LICENSE-2.0
        -:    8: *
        -:    9: * Unless required by applicable law or agreed to in writing, software
        -:   10: * distributed under the License is distributed on an "AS IS" BASIS
        -:   11: * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
        -:   12: * See the License for the specific language governing permissions and
        -:   13: * limitations under the License.
        -:   14: */
        -:   15:
        -:   16:#include "jerryscript.h"
        -:   17:#include "jerryscript-port.h"
        -:   18:#include "test-common.h"
        -:   19:
        -:   20:static int counter = 0;
        -:   21:static jerry_value_t global_module_value;
        -:   22:
        -:   23:static jerry_value_t
    #####:   24:global_assert (const jerry_call_info_t *call_info_p, /**< call information */
        -:   25:               const jerry_value_t args_p[], /**< arguments list */
        -:   26:               const jerry_length_t args_cnt) /**< arguments length */
        -:   27:{
        -:   28:  JERRY_UNUSED (call_info_p);
        -:   29:
    #####:   30:  TEST_ASSERT (args_cnt == 1 && jerry_value_is_true (args_p[0]));
    #####:   31:  return jerry_create_boolean (true);
        -:   32:} /* global_assert */
        -:   33:
        -:   34:static void
    #####:   35:register_assert (void)
        -:   36:{
    #####:   37:  jerry_value_t global_object_value = jerry_get_global_object ();
        -:   38:
    #####:   39:  jerry_value_t function_value = jerry_create_external_function (global_assert);
    #####:   40:  jerry_value_t function_name_value = jerry_create_string ((const jerry_char_t *) "assert");
    #####:   41:  jerry_value_t result_value = jerry_set_property (global_object_value, function_name_value, function_value);
        -:   42:
    #####:   43:  jerry_release_value (function_name_value);
    #####:   44:  jerry_release_value (function_value);
    #####:   45:  jerry_release_value (global_object_value);
        -:   46:
    #####:   47:  TEST_ASSERT (jerry_value_is_true (result_value));
    #####:   48:  jerry_release_value (result_value);
    #####:   49:} /* register_assert */
        -:   50:
        -:   51:static void
    #####:   52:module_import_meta_callback (const jerry_value_t module, /**< module */
        -:   53:                             const jerry_value_t meta_object, /**< import.meta object */
        -:   54:                             void *user_p) /**< user pointer */
        -:   55:{
    #####:   56:  TEST_ASSERT (user_p == (void *) &counter);
    #####:   57:  TEST_ASSERT (module == global_module_value);
        -:   58:
    #####:   59:  jerry_value_t property_name_value = jerry_create_string ((const jerry_char_t *) "prop");
    #####:   60:  jerry_value_t result_value = jerry_set_property (meta_object, property_name_value, property_name_value);
    #####:   61:  jerry_release_value (result_value);
    #####:   62:  jerry_release_value (property_name_value);
        -:   63:
    #####:   64:  counter++;
    #####:   65:} /* module_import_meta_callback */
        -:   66:
        -:   67:static void
    #####:   68:test_syntax_error (const char *source_p, /**< source code */
        -:   69:                   const jerry_parse_options_t *options_p) /**< parse options */
        -:   70:{
    #####:   71:  jerry_value_t result_value = jerry_parse ((const jerry_char_t *) source_p, strlen (source_p), options_p);
    #####:   72:  TEST_ASSERT (jerry_value_is_error (result_value)
        -:   73:               && jerry_get_error_type (result_value) == JERRY_ERROR_SYNTAX);
    #####:   74:  jerry_release_value (result_value);
    #####:   75:} /* test_syntax_error */
        -:   76:
        -:   77:static void
    #####:   78:run_module (const char *source_p, /* source code */
        -:   79:            jerry_parse_options_t *parse_options_p) /* parse options */
        -:   80:{
    #####:   81:  global_module_value = jerry_parse ((const jerry_char_t *) source_p, strlen (source_p), parse_options_p);
    #####:   82:  TEST_ASSERT (!jerry_value_is_error (global_module_value));
        -:   83:
    #####:   84:  jerry_value_t result_value = jerry_module_link (global_module_value, NULL, NULL);
    #####:   85:  TEST_ASSERT (!jerry_value_is_error (result_value));
    #####:   86:  jerry_release_value (result_value);
        -:   87:
    #####:   88:  result_value = jerry_module_evaluate (global_module_value);
        -:   89:
    #####:   90:  jerry_release_value (global_module_value);
        -:   91:
    #####:   92:  TEST_ASSERT (!jerry_value_is_error (result_value));
    #####:   93:  jerry_release_value (result_value);
    #####:   94:} /* run_module */
        -:   95:
        -:   96:int
    #####:   97:main (void)
        -:   98:{
    #####:   99:  jerry_init (JERRY_INIT_EMPTY);
        -:  100:
    #####:  101:  if (!jerry_is_feature_enabled (JERRY_FEATURE_MODULE))
        -:  102:  {
    #####:  103:    jerry_port_log (JERRY_LOG_LEVEL_ERROR, "Module is disabled!\n");
    #####:  104:    jerry_cleanup ();
    #####:  105:    return 0;
        -:  106:  }
        -:  107:
    #####:  108:  register_assert ();
    #####:  109:  jerry_module_set_import_meta_callback (module_import_meta_callback, (void *) &counter);
        -:  110:
        -:  111:  /* Syntax errors. */
    #####:  112:  test_syntax_error ("import.meta", NULL);
    #####:  113:  test_syntax_error ("var a = import.meta", NULL);
        -:  114:
        -:  115:  jerry_parse_options_t parse_options;
    #####:  116:  parse_options.options = JERRY_PARSE_MODULE;
        -:  117:
    #####:  118:  test_syntax_error ("import.m\\u0065ta", &parse_options);
    #####:  119:  test_syntax_error ("import.invalid", &parse_options);
        -:  120:
    #####:  121:  counter = 0;
        -:  122:
    #####:  123:  run_module (TEST_STRING_LITERAL ("assert(typeof import.meta === 'object')\n"),
        -:  124:              &parse_options);
        -:  125:
    #####:  126:  run_module (TEST_STRING_LITERAL ("assert(Object.getPrototypeOf(import.meta) === null)\n"),
        -:  127:              &parse_options);
        -:  128:
    #####:  129:  run_module (TEST_STRING_LITERAL ("var meta = import.meta\n"
        -:  130:                                   "assert(import.meta === meta)\n"
        -:  131:                                   "assert(import.meta === meta)\n"
        -:  132:                                   "function f() {\n"
        -:  133:                                   "  assert(import.meta === meta)\n"
        -:  134:                                   "}\n"
        -:  135:                                   "f()\n"),
        -:  136:              &parse_options);
        -:  137:
    #####:  138:  run_module (TEST_STRING_LITERAL ("import.meta.x = 5.5\n"
        -:  139:                                   "assert(import.meta.x === 5.5)\n"),
        -:  140:              &parse_options);
        -:  141:
    #####:  142:  run_module (TEST_STRING_LITERAL ("assert(import.meta.prop === 'prop')\n"
        -:  143:                                   "function f() {\n"
        -:  144:                                   "  import.meta.prop = 6.25\n"
        -:  145:                                   "  import.meta.prop2 = 's'\n"
        -:  146:                                   "\n"
        -:  147:                                   "  return function() {\n"
        -:  148:                                   "    assert(import.meta.prop === 6.25)\n"
        -:  149:                                   "    assert(import.meta.prop2 === 's')\n"
        -:  150:                                   "  }\n"
        -:  151:                                   "}\n"
        -:  152:                                   "f()()\n"),
        -:  153:              &parse_options);
        -:  154:
    #####:  155:  TEST_ASSERT (counter == 5);
        -:  156:
    #####:  157:  jerry_cleanup ();
    #####:  158:  return 0;
        -:  159:} /* main */
