        -:    0:Source:/home/workspace/tests/unit-core/test-promise-callback.c
        -:    0:Programs:299
        -:    1:/* Copyright JS Foundation and other contributors, http://js.foundation
        -:    2: *
        -:    3: * Licensed under the Apache License, Version 2.0 (the "License");
        -:    4: * you may not use this file except in compliance with the License.
        -:    5: * You may obtain a copy of the License at
        -:    6: *
        -:    7: *     http://www.apache.org/licenses/LICENSE-2.0
        -:    8: *
        -:    9: * Unless required by applicable law or agreed to in writing, software
        -:   10: * distributed under the License is distributed on an "AS IS" BASIS
        -:   11: * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
        -:   12: * See the License for the specific language governing permissions and
        -:   13: * limitations under the License.
        -:   14: */
        -:   15:
        -:   16:#include "jerryscript.h"
        -:   17:
        -:   18:#include "test-common.h"
        -:   19:
        -:   20:/* Note: RS = ReSolve, RJ = ReJect */
        -:   21:typedef enum
        -:   22:{
        -:   23:  C = JERRY_PROMISE_EVENT_CREATE, /**< same as JERRY_PROMISE_CALLBACK_CREATE with undefined value */
        -:   24:  RS = JERRY_PROMISE_EVENT_RESOLVE, /**< same as JERRY_PROMISE_CALLBACK_RESOLVE */
        -:   25:  RJ = JERRY_PROMISE_EVENT_REJECT, /**< same as JERRY_PROMISE_CALLBACK_REJECT */
        -:   26:  RSF = JERRY_PROMISE_EVENT_RESOLVE_FULFILLED, /**< same as JERRY_PROMISE_EVENT_RESOLVE_FULFILLED */
        -:   27:  RJF = JERRY_PROMISE_EVENT_REJECT_FULFILLED, /**< same as JERRY_PROMISE_EVENT_REJECT_FULFILLED */
        -:   28:  RWH = JERRY_PROMISE_EVENT_REJECT_WITHOUT_HANDLER, /**< same as JERRY_PROMISE_EVENT_REJECT_WITHOUT_HANDLER */
        -:   29:  CHA = JERRY_PROMISE_EVENT_CATCH_HANDLER_ADDED, /**< same as JERRY_PROMISE_EVENT_CATCH_HANDLER_ADDED */
        -:   30:  BR = JERRY_PROMISE_EVENT_BEFORE_REACTION_JOB, /**< same as JERRY_PROMISE_CALLBACK_BEFORE_REACTION_JOB */
        -:   31:  AR = JERRY_PROMISE_EVENT_AFTER_REACTION_JOB, /**< same as JERRY_PROMISE_CALLBACK_AFTER_REACTION_JOB */
        -:   32:  A = JERRY_PROMISE_EVENT_ASYNC_AWAIT, /**< same as JERRY_PROMISE_CALLBACK_ASYNC_AWAIT */
        -:   33:  BRS = JERRY_PROMISE_EVENT_ASYNC_BEFORE_RESOLVE, /**< same as JERRY_PROMISE_CALLBACK_ASYNC_BEFORE_RESOLVE */
        -:   34:  BRJ = JERRY_PROMISE_EVENT_ASYNC_BEFORE_REJECT, /**< same as JERRY_PROMISE_CALLBACK_ASYNC_BEFORE_REJECT */
        -:   35:  ARS = JERRY_PROMISE_EVENT_ASYNC_AFTER_RESOLVE, /**< same as JERRY_PROMISE_CALLBACK_ASYNC_AFTER_RESOLVE */
        -:   36:  ARJ = JERRY_PROMISE_EVENT_ASYNC_AFTER_REJECT, /**< same as JERRY_PROMISE_CALLBACK_ASYNC_AFTER_REJECT */
        -:   37:  CP = UINT8_MAX - 1, /**< same as JERRY_PROMISE_CALLBACK_CREATE with Promise value */
        -:   38:  E = UINT8_MAX, /**< marks the end of the event list */
        -:   39:} jerry_promise_callback_event_abbreviations_t;
        -:   40:
        -:   41:static int user;
        -:   42:static const uint8_t *next_event_p;
        -:   43:
        -:   44:static void
    #####:   45:promise_callback (jerry_promise_event_type_t event_type, /**< event type */
        -:   46:                  const jerry_value_t object, /**< target object */
        -:   47:                  const jerry_value_t value, /**< optional argument */
        -:   48:                  void *user_p) /**< user pointer passed to the callback */
        -:   49:{
    #####:   50:  TEST_ASSERT (user_p == (void *) &user);
        -:   51:
    #####:   52:  switch (event_type)
        -:   53:  {
    #####:   54:    case JERRY_PROMISE_EVENT_CREATE:
        -:   55:    {
    #####:   56:      TEST_ASSERT (jerry_value_is_promise (object));
    #####:   57:      if (jerry_value_is_undefined (value))
        -:   58:      {
        -:   59:        break;
        -:   60:      }
        -:   61:
    #####:   62:      TEST_ASSERT (jerry_value_is_promise (value));
    #####:   63:      TEST_ASSERT (*next_event_p++ == CP);
        -:   64:      return;
        -:   65:    }
    #####:   66:    case JERRY_PROMISE_EVENT_RESOLVE:
        -:   67:    case JERRY_PROMISE_EVENT_REJECT:
        -:   68:    case JERRY_PROMISE_EVENT_RESOLVE_FULFILLED:
        -:   69:    case JERRY_PROMISE_EVENT_REJECT_FULFILLED:
        -:   70:    case JERRY_PROMISE_EVENT_REJECT_WITHOUT_HANDLER:
        -:   71:    {
    #####:   72:      TEST_ASSERT (jerry_value_is_promise (object));
        -:   73:      break;
        -:   74:    }
    #####:   75:    case JERRY_PROMISE_EVENT_CATCH_HANDLER_ADDED:
        -:   76:    case JERRY_PROMISE_EVENT_BEFORE_REACTION_JOB:
        -:   77:    case JERRY_PROMISE_EVENT_AFTER_REACTION_JOB:
        -:   78:    {
    #####:   79:      TEST_ASSERT (jerry_value_is_promise (object));
    #####:   80:      TEST_ASSERT (jerry_value_is_undefined (value));
        -:   81:      break;
        -:   82:    }
    #####:   83:    case JERRY_PROMISE_EVENT_ASYNC_AWAIT:
        -:   84:    {
    #####:   85:      TEST_ASSERT (jerry_value_is_object (object));
    #####:   86:      TEST_ASSERT (jerry_value_is_promise (value));
        -:   87:      break;
        -:   88:    }
    #####:   89:    default:
        -:   90:    {
    #####:   91:      TEST_ASSERT (event_type == JERRY_PROMISE_EVENT_ASYNC_BEFORE_RESOLVE
        -:   92:                   || event_type == JERRY_PROMISE_EVENT_ASYNC_BEFORE_REJECT
        -:   93:                   || event_type == JERRY_PROMISE_EVENT_ASYNC_AFTER_RESOLVE
        -:   94:                   || event_type == JERRY_PROMISE_EVENT_ASYNC_AFTER_REJECT);
    #####:   95:      TEST_ASSERT (jerry_value_is_object (object));
        -:   96:      break;
        -:   97:    }
        -:   98:  }
        -:   99:
    #####:  100:  TEST_ASSERT (*next_event_p++ == (uint8_t) event_type);
        -:  101:} /* promise_callback */
        -:  102:
        -:  103:static void
    #####:  104:run_eval (const uint8_t *event_list_p, /**< event list */
        -:  105:          const char *source_p) /**< source code */
        -:  106:{
    #####:  107:  next_event_p = event_list_p;
        -:  108:
    #####:  109:  jerry_value_t result = jerry_eval ((const jerry_char_t *) source_p, strlen (source_p), 0);
        -:  110:
    #####:  111:  TEST_ASSERT (!jerry_value_is_exception (result));
    #####:  112:  jerry_value_free (result);
        -:  113:
    #####:  114:  result = jerry_run_jobs ();
    #####:  115:  TEST_ASSERT (!jerry_value_is_exception (result));
    #####:  116:  jerry_value_free (result);
        -:  117:
    #####:  118:  TEST_ASSERT (*next_event_p == UINT8_MAX);
    #####:  119:} /* run_eval */
        -:  120:
        -:  121:int
    #####:  122:main (void)
        -:  123:{
    #####:  124:  TEST_INIT ();
        -:  125:
    #####:  126:  if (!jerry_feature_enabled (JERRY_FEATURE_PROMISE))
        -:  127:  {
    #####:  128:    jerry_port_log (JERRY_LOG_LEVEL_ERROR, "Promise is disabled!\n");
    #####:  129:    return 0;
        -:  130:  }
        -:  131:
        -:  132:  /* The test system enables this feature when Promises are enabled. */
    #####:  133:  TEST_ASSERT (jerry_feature_enabled (JERRY_FEATURE_PROMISE_CALLBACK));
        -:  134:
    #####:  135:  jerry_init (JERRY_INIT_EMPTY);
        -:  136:
    #####:  137:  jerry_promise_event_filter_t filters =
        -:  138:    (JERRY_PROMISE_EVENT_FILTER_CREATE | JERRY_PROMISE_EVENT_FILTER_RESOLVE | JERRY_PROMISE_EVENT_FILTER_REJECT
        -:  139:     | JERRY_PROMISE_EVENT_FILTER_ERROR | JERRY_PROMISE_EVENT_FILTER_REACTION_JOB
        -:  140:     | JERRY_PROMISE_EVENT_FILTER_ASYNC_MAIN | JERRY_PROMISE_EVENT_FILTER_ASYNC_REACTION_JOB);
        -:  141:
    #####:  142:  jerry_promise_on_event (filters, promise_callback, (void *) &user);
        -:  143:
        -:  144:  /* Test promise creation. */
        -:  145:  static uint8_t events1[] = { C, C, C, E };
        -:  146:
    #####:  147:  run_eval (events1,
        -:  148:            "'use strict'\n"
        -:  149:            "new Promise((res, rej) => {})\n"
        -:  150:            "new Promise((res, rej) => {})\n"
        -:  151:            "new Promise((res, rej) => {})\n");
        -:  152:
        -:  153:  /* Test then call. */
        -:  154:  static uint8_t events2[] = { C, CP, E };
        -:  155:
    #####:  156:  run_eval (events2,
        -:  157:            "'use strict'\n"
        -:  158:            "var promise = new Promise((res, rej) => {})\n"
        -:  159:            "promise.then(() => {}, () => {})\n");
        -:  160:
        -:  161:  /* Test then call with extended Promise. */
        -:  162:  static uint8_t events3[] = { C, C, E };
        -:  163:
    #####:  164:  run_eval (events3,
        -:  165:            "'use strict'\n"
        -:  166:            "var P = class extends Promise {}\n"
        -:  167:            "var promise = new P((res, rej) => {})\n"
        -:  168:            "promise.then(() => {})\n");
        -:  169:
        -:  170:  /* Test resolve and reject calls. */
        -:  171:  static uint8_t events4[] = { C, C, RS, RJ, RWH, E };
        -:  172:
    #####:  173:  run_eval (events4,
        -:  174:            "'use strict'\n"
        -:  175:            "var resolve\n"
        -:  176:            "var reject\n"
        -:  177:            "new Promise((res, rej) => resolve = res)\n"
        -:  178:            "new Promise((res, rej) => reject = rej)\n"
        -:  179:            "resolve(1)\n"
        -:  180:            "reject(1)\n");
        -:  181:
        -:  182:  /* Test then and resolve calls. */
        -:  183:  static uint8_t events5[] = { C, CP, RS, BR, RS, AR, E };
        -:  184:
    #####:  185:  run_eval (events5,
        -:  186:            "'use strict'\n"
        -:  187:            "var resolve\n"
        -:  188:            "var promise = new Promise((res, rej) => resolve = res)\n"
        -:  189:            "promise.then(() => {})\n"
        -:  190:            "resolve(1)\n");
        -:  191:
        -:  192:  /* Test resolve and then calls. */
        -:  193:  static uint8_t events6[] = { C, RS, CP, BR, RS, AR, E };
        -:  194:
    #####:  195:  run_eval (events6,
        -:  196:            "'use strict'\n"
        -:  197:            "var promise = new Promise((res, rej) => res(1))\n"
        -:  198:            "promise.then(() => {})\n");
        -:  199:
        -:  200:  /* Test Promise.resolve. */
        -:  201:  static uint8_t events7[] = { C, RS, CP, BR, RS, AR, E };
        -:  202:
    #####:  203:  run_eval (events7, "Promise.resolve(4).then(() => {})\n");
        -:  204:
        -:  205:  /* Test Promise.reject. */
        -:  206:  static uint8_t events8[] = { C, RJ, RWH, CP, CHA, BR, RJ, RWH, AR, E };
        -:  207:
    #####:  208:  run_eval (events8, "Promise.reject(4).catch(() => { throw 'Error' })\n");
        -:  209:
        -:  210:  /* Test Promise.race without resolve */
        -:  211:  static uint8_t events9[] = { C, C, C, CP, CP, E };
        -:  212:
    #####:  213:  run_eval (events9,
        -:  214:            "'use strict'\n"
        -:  215:            "var p1 = new Promise((res, rej) => {})\n"
        -:  216:            "var p2 = new Promise((res, rej) => {})\n"
        -:  217:            "Promise.race([p1,p2])\n");
        -:  218:
        -:  219:  /* Test Promise.race with resolve. */
        -:  220:  static uint8_t events10[] = { C, RS, C, RJ, RWH, C, CP, CP, CHA, BR, RS, RS, AR, BR, RJF, RS, AR, E };
        -:  221:
    #####:  222:  run_eval (events10,
        -:  223:            "'use strict'\n"
        -:  224:            "var p1 = new Promise((res, rej) => res(1))\n"
        -:  225:            "var p2 = new Promise((res, rej) => rej(1))\n"
        -:  226:            "Promise.race([p1,p2])\n");
        -:  227:
        -:  228:  /* Test Promise.all without resolve. */
        -:  229:  static uint8_t events11[] = { C, C, C, CP, CP, E };
        -:  230:
    #####:  231:  run_eval (events11,
        -:  232:            "'use strict'\n"
        -:  233:            "var p1 = new Promise((res, rej) => {})\n"
        -:  234:            "var p2 = new Promise((res, rej) => {})\n"
        -:  235:            "Promise.all([p1,p2])\n");
        -:  236:
        -:  237:  /* Test Promise.all with resolve. */
        -:  238:  static uint8_t events12[] = { C, RS, C, RJ, RWH, C, CP, CP, CHA, BR, RS, AR, BR, RJ, RWH, RS, AR, E };
        -:  239:
    #####:  240:  run_eval (events12,
        -:  241:            "'use strict'\n"
        -:  242:            "var p1 = new Promise((res, rej) => res(1))\n"
        -:  243:            "var p2 = new Promise((res, rej) => rej(1))\n"
        -:  244:            "Promise.all([p1,p2])\n");
        -:  245:
        -:  246:  /* Test async function. */
        -:  247:  static uint8_t events13[] = { C, RS, E };
        -:  248:
    #####:  249:  run_eval (events13,
        -:  250:            "'use strict'\n"
        -:  251:            "async function f() {}\n"
        -:  252:            "f()\n");
        -:  253:
        -:  254:  /* Test await with resolved Promise. */
        -:  255:  static uint8_t events14[] = { C, RS, A, C, BRS, RS, ARS, E };
        -:  256:
    #####:  257:  run_eval (events14,
        -:  258:            "'use strict'\n"
        -:  259:            "async function f(p) { await p }\n"
        -:  260:            "f(Promise.resolve(1))\n");
        -:  261:
        -:  262:  /* Test await with non-Promise value. */
        -:  263:  static uint8_t events15[] = { C, RS, A, C, BRS, C, RS, A, ARS, BRS, RS, ARS, E };
        -:  264:
    #####:  265:  run_eval (events15,
        -:  266:            "'use strict'\n"
        -:  267:            "async function f(p) { await p; await 'X' }\n"
        -:  268:            "f(Promise.resolve(1))\n");
        -:  269:
        -:  270:  /* Test await with rejected Promise. */
        -:  271:  static uint8_t events16[] = { C, RJ, RWH, A, CHA, C, BRJ, C, RS, RS, ARJ, E };
        -:  272:
    #####:  273:  run_eval (events16,
        -:  274:            "'use strict'\n"
        -:  275:            "async function f(p) { try { await p; } catch (e) { Promise.resolve(1) } }\n"
        -:  276:            "f(Promise.reject(1))\n");
        -:  277:
        -:  278:  /* Test async generator function. */
        -:  279:  static uint8_t events17[] = { C, RS, C, A, BRS, RS, ARS, E };
        -:  280:
    #####:  281:  run_eval (events17,
        -:  282:            "'use strict'\n"
        -:  283:            "async function *f(p) { await p; return 4 }\n"
        -:  284:            "f(Promise.resolve(1)).next()\n");
        -:  285:
        -:  286:  /* Test yield* operation. */
        -:  287:  static uint8_t events18[] = { C, C, RS, A, BRS, C, RS, A, ARS, BRS, RS, ARS, E };
        -:  288:
    #####:  289:  run_eval (events18,
        -:  290:            "'use strict'\n"
        -:  291:            "async function *f(p) { yield 1 }\n"
        -:  292:            "async function *g() { yield* f() }\n"
        -:  293:            "g().next()\n");
        -:  294:
        -:  295:  /* Test multiple fulfill operations. */
        -:  296:  static uint8_t events19[] = { C, RS, RSF, RJF, E };
        -:  297:
    #####:  298:  run_eval (events19,
        -:  299:            "'use strict'\n"
        -:  300:            "var resolve, reject\n"
        -:  301:            "var p1 = new Promise((res, rej) => { resolve = res, reject = rej })\n"
        -:  302:            "resolve(1)\n"
        -:  303:            "resolve(2)\n"
        -:  304:            "reject(3)\n");
        -:  305:
        -:  306:  /* Test multiple fulfill operations. */
        -:  307:  static uint8_t events20[] = { C, RJ, RWH, RSF, RJF, E };
        -:  308:
    #####:  309:  run_eval (events20,
        -:  310:            "'use strict'\n"
        -:  311:            "var resolve, reject\n"
        -:  312:            "var p1 = new Promise((res, rej) => { resolve = res, reject = rej })\n"
        -:  313:            "reject(1)\n"
        -:  314:            "resolve(2)\n"
        -:  315:            "reject(3)\n");
        -:  316:
        -:  317:  /* Test catch handler added later is reported only once. */
        -:  318:  static uint8_t events21[] = { C, RJ, RWH, CP, CHA, CP, CP, BR, RS, AR, BR, RS, AR, BR, RS, AR, E };
        -:  319:
    #####:  320:  run_eval (events21,
        -:  321:            "'use strict'\n"
        -:  322:            "var rej = Promise.reject(4)\n"
        -:  323:            "rej.catch(() => {})\n"
        -:  324:            "rej.catch(() => {})\n"
        -:  325:            "rej.catch(() => {})\n");
        -:  326:
        -:  327:  /* Test catch handler added later is reported only once. */
        -:  328:  static uint8_t events22[] = { C, RJ, RWH, A, CHA, C, BRJ, A, ARJ, BRJ, RJ, RWH, ARJ, E };
        -:  329:
    #####:  330:  run_eval (events22,
        -:  331:            "'use strict'\n"
        -:  332:            "async function f(p) { try { await p; } catch(e) { await p; } }"
        -:  333:            "f(Promise.reject(4))\n");
        -:  334:
        -:  335:  /* Test chained then. */
        -:  336:  static uint8_t events23[] = { C, RJ, RWH, CP, CHA, CP, BR, RJ, AR, BR, RS, AR, E };
        -:  337:
    #####:  338:  run_eval (events23,
        -:  339:            "'use strict'\n"
        -:  340:            "var p = Promise.reject(0)\n"
        -:  341:            "p.then(() => {}).catch(() => {})\n");
        -:  342:
        -:  343:  /* Test disabled filters. */
    #####:  344:  jerry_promise_on_event (JERRY_PROMISE_EVENT_FILTER_DISABLE, promise_callback, (void *) &user);
        -:  345:
        -:  346:  static uint8_t events24[] = { E };
        -:  347:
    #####:  348:  run_eval (events24,
        -:  349:            "'use strict'\n"
        -:  350:            "async function f(p) { await p }"
        -:  351:            "f(Promise.resolve(1))\n");
        -:  352:
        -:  353:  /* Test filtered events. */
    #####:  354:  filters = JERRY_PROMISE_EVENT_FILTER_REACTION_JOB | JERRY_PROMISE_EVENT_FILTER_ASYNC_REACTION_JOB;
    #####:  355:  jerry_promise_on_event (filters, promise_callback, (void *) &user);
        -:  356:
        -:  357:  static uint8_t events25[] = { BR, AR, BRS, ARS, E };
        -:  358:
    #####:  359:  run_eval (events25,
        -:  360:            "'use strict'\n"
        -:  361:            "async function f(p) { await p }"
        -:  362:            "f(Promise.resolve(1).then(() => {}))\n");
        -:  363:
    #####:  364:  jerry_cleanup ();
    #####:  365:  return 0;
        -:  366:} /* main */
