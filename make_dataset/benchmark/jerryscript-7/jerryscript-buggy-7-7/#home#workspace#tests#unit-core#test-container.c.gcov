        -:    0:Source:/home/workspace/tests/unit-core/test-container.c
        -:    0:Programs:299
        -:    1:/* Copyright JS Foundation and other contributors, http://js.foundation
        -:    2: *
        -:    3: * Licensed under the Apache License, Version 2.0 (the "License");
        -:    4: * you may not use this file except in compliance with the License.
        -:    5: * You may obtain a copy of the License at
        -:    6: *
        -:    7: *     http://www.apache.org/licenses/LICENSE-2.0
        -:    8: *
        -:    9: * Unless required by applicable law or agreed to in writing, software
        -:   10: * distributed under the License is distributed on an "AS IS" BASIS
        -:   11: * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
        -:   12: * See the License for the specific language governing permissions and
        -:   13: * limitations under the License.
        -:   14: */
        -:   15:
        -:   16:#include "jerryscript.h"
        -:   17:
        -:   18:#include "test-common.h"
        -:   19:
        -:   20:static int global_counter;
        -:   21:
        -:   22:static void
    #####:   23:native_free_callback (void *native_p, /**< native pointer */
        -:   24:                      jerry_object_native_info_t *info_p) /**< native info */
        -:   25:{
    #####:   26:  TEST_ASSERT (native_p == (void *) &global_counter);
    #####:   27:  TEST_ASSERT (info_p->free_cb == native_free_callback);
    #####:   28:  global_counter++;
    #####:   29:} /* native_free_callback */
        -:   30:
        -:   31:static const jerry_object_native_info_t native_info = {
        -:   32:  .free_cb = native_free_callback,
        -:   33:  .number_of_references = 0,
        -:   34:  .offset_of_references = 0,
        -:   35:};
        -:   36:
        -:   37:static jerry_value_t
    #####:   38:create_array_from_container_handler (const jerry_call_info_t *call_info_p,
        -:   39:                                     const jerry_value_t args_p[],
        -:   40:                                     const jerry_length_t args_count)
        -:   41:{
        -:   42:  JERRY_UNUSED (call_info_p);
        -:   43:
    #####:   44:  if (args_count < 2)
        -:   45:  {
    #####:   46:    return jerry_undefined ();
        -:   47:  }
        -:   48:
    #####:   49:  bool is_key_value_pairs = false;
    #####:   50:  jerry_value_t result = jerry_container_to_array (args_p[0], &is_key_value_pairs);
        -:   51:
    #####:   52:  TEST_ASSERT (is_key_value_pairs == jerry_value_is_true (args_p[1]));
        -:   53:  return result;
        -:   54:} /* create_array_from_container_handler */
        -:   55:
        -:   56:static void
    #####:   57:run_eval (const char *source_p)
        -:   58:{
    #####:   59:  jerry_value_t result = jerry_eval ((const jerry_char_t *) source_p, strlen (source_p), 0);
        -:   60:
    #####:   61:  TEST_ASSERT (!jerry_value_is_exception (result));
    #####:   62:  jerry_value_free (result);
    #####:   63:} /* run_eval */
        -:   64:
        -:   65:static void
    #####:   66:run_eval_error (const char *source_p)
        -:   67:{
    #####:   68:  jerry_value_t result = jerry_eval ((const jerry_char_t *) source_p, strlen (source_p), 0);
    #####:   69:  jerry_value_free (result);
    #####:   70:} /* run_eval_error */
        -:   71:
        -:   72:int
    #####:   73:main (void)
        -:   74:{
    #####:   75:  jerry_init (JERRY_INIT_EMPTY);
        -:   76:
    #####:   77:  if (!jerry_feature_enabled (JERRY_FEATURE_MAP) || !jerry_feature_enabled (JERRY_FEATURE_SET)
    #####:   78:      || !jerry_feature_enabled (JERRY_FEATURE_WEAKMAP) || !jerry_feature_enabled (JERRY_FEATURE_WEAKSET))
        -:   79:  {
    #####:   80:    jerry_port_log (JERRY_LOG_LEVEL_ERROR, "Containers are disabled!\n");
    #####:   81:    jerry_cleanup ();
    #####:   82:    return 0;
        -:   83:  }
        -:   84:
        -:   85:  jerry_value_t instance_check;
    #####:   86:  jerry_value_t global = jerry_current_realm ();
    #####:   87:  jerry_value_t map_str = jerry_string_sz ("Map");
    #####:   88:  jerry_value_t set_str = jerry_string_sz ("Set");
    #####:   89:  jerry_value_t weakmap_str = jerry_string_sz ("WeakMap");
    #####:   90:  jerry_value_t weakset_str = jerry_string_sz ("WeakSet");
    #####:   91:  jerry_value_t global_map = jerry_object_get (global, map_str);
    #####:   92:  jerry_value_t global_set = jerry_object_get (global, set_str);
    #####:   93:  jerry_value_t global_weakmap = jerry_object_get (global, weakmap_str);
    #####:   94:  jerry_value_t global_weakset = jerry_object_get (global, weakset_str);
        -:   95:
    #####:   96:  jerry_value_t function = jerry_function_external (create_array_from_container_handler);
    #####:   97:  jerry_value_t name = jerry_string_sz ("create_array_from_container");
    #####:   98:  jerry_value_t res = jerry_object_set (global, name, function);
    #####:   99:  TEST_ASSERT (!jerry_value_is_exception (res));
        -:  100:
    #####:  101:  jerry_value_free (res);
    #####:  102:  jerry_value_free (name);
    #####:  103:  jerry_value_free (function);
        -:  104:
    #####:  105:  jerry_value_free (global);
        -:  106:
    #####:  107:  jerry_value_free (map_str);
    #####:  108:  jerry_value_free (set_str);
    #####:  109:  jerry_value_free (weakmap_str);
    #####:  110:  jerry_value_free (weakset_str);
        -:  111:
    #####:  112:  jerry_value_t empty_map = jerry_container (JERRY_CONTAINER_TYPE_MAP, NULL, 0);
    #####:  113:  TEST_ASSERT (jerry_container_type (empty_map) == JERRY_CONTAINER_TYPE_MAP);
    #####:  114:  instance_check = jerry_binary_op (JERRY_BIN_OP_INSTANCEOF, empty_map, global_map);
    #####:  115:  TEST_ASSERT (jerry_value_is_true (instance_check));
    #####:  116:  jerry_value_free (instance_check);
    #####:  117:  jerry_value_free (global_map);
    #####:  118:  jerry_value_free (empty_map);
        -:  119:
    #####:  120:  jerry_value_t empty_set = jerry_container (JERRY_CONTAINER_TYPE_SET, NULL, 0);
    #####:  121:  TEST_ASSERT (jerry_container_type (empty_set) == JERRY_CONTAINER_TYPE_SET);
    #####:  122:  instance_check = jerry_binary_op (JERRY_BIN_OP_INSTANCEOF, empty_set, global_set);
    #####:  123:  TEST_ASSERT (jerry_value_is_true (instance_check));
    #####:  124:  jerry_value_free (instance_check);
    #####:  125:  jerry_value_free (global_set);
    #####:  126:  jerry_value_free (empty_set);
        -:  127:
    #####:  128:  jerry_value_t empty_weakmap = jerry_container (JERRY_CONTAINER_TYPE_WEAKMAP, NULL, 0);
    #####:  129:  TEST_ASSERT (jerry_container_type (empty_weakmap) == JERRY_CONTAINER_TYPE_WEAKMAP);
    #####:  130:  instance_check = jerry_binary_op (JERRY_BIN_OP_INSTANCEOF, empty_weakmap, global_weakmap);
    #####:  131:  TEST_ASSERT (jerry_value_is_true (instance_check));
    #####:  132:  jerry_value_free (instance_check);
    #####:  133:  jerry_value_free (global_weakmap);
    #####:  134:  jerry_value_free (empty_weakmap);
        -:  135:
    #####:  136:  jerry_value_t empty_weakset = jerry_container (JERRY_CONTAINER_TYPE_WEAKSET, NULL, 0);
    #####:  137:  TEST_ASSERT (jerry_container_type (empty_weakset) == JERRY_CONTAINER_TYPE_WEAKSET);
    #####:  138:  instance_check = jerry_binary_op (JERRY_BIN_OP_INSTANCEOF, empty_weakset, global_weakset);
    #####:  139:  TEST_ASSERT (jerry_value_is_true (instance_check));
    #####:  140:  jerry_value_free (instance_check);
    #####:  141:  jerry_value_free (global_weakset);
    #####:  142:  jerry_value_free (empty_weakset);
        -:  143:
    #####:  144:  const jerry_char_t source[] = TEST_STRING_LITERAL ("(function () {\n"
        -:  145:                                                     "  var o1 = {}\n"
        -:  146:                                                     "  var o2 = {}\n"
        -:  147:                                                     "  var o3 = {}\n"
        -:  148:                                                     "  var wm = new WeakMap()\n"
        -:  149:                                                     "  wm.set(o1, o2)\n"
        -:  150:                                                     "  wm.set(o2, o3)\n"
        -:  151:                                                     "  return o3\n"
        -:  152:                                                     "})()\n");
    #####:  153:  jerry_value_t result = jerry_eval (source, sizeof (source) - 1, JERRY_PARSE_NO_OPTS);
    #####:  154:  TEST_ASSERT (jerry_value_is_object (result));
        -:  155:
    #####:  156:  jerry_object_set_native_ptr (result, &native_info, (void *) &global_counter);
    #####:  157:  jerry_value_free (result);
        -:  158:
    #####:  159:  global_counter = 0;
    #####:  160:  jerry_heap_gc (JERRY_GC_PRESSURE_LOW);
    #####:  161:  TEST_ASSERT (global_counter == 1);
        -:  162:
    #####:  163:  run_eval ("function assert(v) {\n"
        -:  164:            "  if(v !== true)\n"
        -:  165:            "    throw 'Assertion failed!'\n"
        -:  166:            "}");
        -:  167:
    #####:  168:  run_eval ("function test_values(arr1, arr2) {\n"
        -:  169:            "  assert(Array.isArray(arr1));\n"
        -:  170:            "  assert(arr1.length == arr2.length);\n"
        -:  171:            "  for(let i = 0; i < arr1.length; i++) {\n"
        -:  172:            "    assert(arr1[i] === arr2[i]);\n"
        -:  173:            "  }\n"
        -:  174:            "}\n");
        -:  175:
    #####:  176:  run_eval ("var map = new Map();\n"
        -:  177:            "map.set(1, 3.14);\n"
        -:  178:            "map.set(2, true);\n"
        -:  179:            "map.set(3, 'foo');\n"
        -:  180:            "var set = new Set();\n"
        -:  181:            "set.add(3.14);\n"
        -:  182:            "set.add(true);\n"
        -:  183:            "set.add('foo');\n"
        -:  184:            "var obj = { x:3, y:'foo'};\n"
        -:  185:            "var b_int = 1n;\n"
        -:  186:            "var obj_bint_map = new Map();\n"
        -:  187:            "obj_bint_map.set(1, obj);\n"
        -:  188:            "obj_bint_map.set(2, b_int);\n");
        -:  189:
    #####:  190:  run_eval ("var result = create_array_from_container(map, true);\n"
        -:  191:            "test_values(result, [1, 3.14, 2, true, 3, 'foo']);");
        -:  192:
    #####:  193:  run_eval ("var result = create_array_from_container(set, false);\n"
        -:  194:            "test_values(result, [3.14, true, 'foo']);");
        -:  195:
    #####:  196:  run_eval ("var result = create_array_from_container(map.entries(), true);\n"
        -:  197:            "test_values(result, [1, 3.14, 2, true, 3, 'foo']);");
        -:  198:
    #####:  199:  run_eval ("var result = create_array_from_container(map.keys(), false);\n"
        -:  200:            "test_values(result, [1, 2, 3,]);");
        -:  201:
    #####:  202:  run_eval ("var result = create_array_from_container(map.values(), false);\n"
        -:  203:            "test_values(result, [3.14, true, 'foo']);");
        -:  204:
    #####:  205:  run_eval ("var result = create_array_from_container(obj_bint_map, true)\n"
        -:  206:            "test_values(result, [1, obj, 2, b_int]);");
        -:  207:
    #####:  208:  run_eval ("var map = new Map();\n"
        -:  209:            "map.set(1, 1);\n"
        -:  210:            "var iter = map.entries();\n"
        -:  211:            "iter.next();\n"
        -:  212:            "var result = create_array_from_container(iter, true);\n"
        -:  213:            "assert(Array.isArray(result));\n"
        -:  214:            "assert(result.length == 0);");
        -:  215:
    #####:  216:  run_eval ("var ws = new WeakSet();\n"
        -:  217:            "var foo = {};\n"
        -:  218:            "var bar = {};\n"
        -:  219:            "ws.add(foo);\n"
        -:  220:            "ws.add(bar);\n"
        -:  221:            "var result = create_array_from_container(ws, false);\n"
        -:  222:            "test_values(result, [foo, bar]);\n");
        -:  223:
    #####:  224:  run_eval ("var ws = new WeakMap();\n"
        -:  225:            "var foo = {};\n"
        -:  226:            "var bar = {};\n"
        -:  227:            "ws.set(foo, 37);\n"
        -:  228:            "ws.set(bar, 'asd');\n"
        -:  229:            "var result = create_array_from_container(ws, true);\n"
        -:  230:            "test_values(result, [foo, 37, bar, 'asd']);\n");
        -:  231:
    #####:  232:  run_eval_error ("var iter = null;\n"
        -:  233:                  "var result = create_array_from_container(iter, false);\n"
        -:  234:                  "assert(result instanceof Error);");
        -:  235:
    #####:  236:  run_eval_error ("var iter = 3;\n"
        -:  237:                  "var result = create_array_from_container(iter, false);\n"
        -:  238:                  "assert(result instanceof Error);");
        -:  239:
    #####:  240:  run_eval_error ("var iter = [3.14, true, 'foo'].entries();\n"
        -:  241:                  "var result = create_array_from_container(iter, false);\n"
        -:  242:                  "assert(result instanceof Error);");
        -:  243:
    #####:  244:  jerry_cleanup ();
    #####:  245:  return 0;
        -:  246:} /* main */
